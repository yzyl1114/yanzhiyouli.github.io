<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GoalCountdown - è€ƒè¯•å€’è®¡æ—¶</title>
  <link rel="stylesheet" href="css/style.css">

  <!-- æ—¶åŒºåº“ -->
  <script src="js/moment.min.js"></script>
  <script src="js/moment-timezone-with-data-10-year-range.min.js"></script>

  <!-- è°·æ­Œå¹¿å‘Š -->
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7268374810307592" crossorigin="anonymous"></script>

  <!-- ä»Šå¤©åŒ—äº¬æ—¶é—´ -->
  <script>
    function setTodayBJ(){
      const weekdays = ["æ—¥","ä¸€","äºŒ","ä¸‰","å››","äº”","å…­"];
      const bj = moment.tz("Asia/Shanghai");
      const str = `${bj.year()}å¹´${bj.month()+1}æœˆ${bj.date()}æ—¥ï¼Œæ˜ŸæœŸ${weekdays[bj.day()]}`;
      document.addEventListener('DOMContentLoaded', ()=>{
        document.getElementById('current-date').textContent = str;
      });
    }
    setTodayBJ();
  </script>
</head>

<body>
  <!-- æ ‡é¢˜æ  -->
  <header class="header">
    <div class="logo-container">
      <img src="images/logo.png" alt="GoalCountdown Logo" class="logo">
      <h1>GoalCountdown</h1>
    </div>
    <div class="date-container" style="margin-left:auto;margin-right:8px;">
      <span id="current-date">2025å¹´01æœˆ01æ—¥ï¼Œæ˜ŸæœŸä¸‰</span>
    </div>
    <!-- ç»Ÿä¸€å¤´åƒå…¥å£ -->
    <img id="user-avatar" src="images/default-avatar.png" style="width:30px;height:30px;border-radius:50%;margin-left:auto;margin-right:20px;cursor:pointer;display:none;">
  </header>

  <!-- Banner -->
  <section class="banner">
    <img src="images/banner.jpg" alt="è€ƒè¯•å€’è®¡æ—¶ç½‘ç«™å®£ä¼ " class="banner-image">
  </section>

  <!-- å€’è®¡æ—¶å…¥å£ -->
  <section class="countdown-entries">
    <div class="entry-grid"></div>
  </section>

  <!-- å¤‡æ¡ˆ -->
  <footer class="footer">
    <div class="beian">
      <a href="https://beian.mps.gov.cn/#/query/webSearch?code=11010502057033" target="_blank" rel="noreferrer">
        <img src="images/beian.png" alt="å…¬å®‰è”ç½‘å¤‡æ¡ˆå›¾æ ‡"> äº¬å…¬ç½‘å®‰å¤‡11010502057033å·
      </a>
      <a href="http://beian.miit.gov.cn/" target="_blank" rel="noreferrer">äº¬ICPå¤‡2024094021å·</a>
    </div>
    <div class="contact">
      <span>å•†åŠ¡åˆä½œ goalcountdown@gmail.com</span>
    </div>
  </footer>

  <!-- æ´»åŠ¨å¼¹çª— -->
  <div class="modal activity-modal" id="activity-modal">
    <div class="modal-content">
      <span class="close-modal">&times;</span>
      <h2 class="modal-title">æ–°ç”¨æˆ·ä¸“äº«æ´»åŠ¨</h2>
      <div class="modal-body">
        <p>æ³¨å†Œå³é€3æ¬¡è‡ªå®šä¹‰å€’è®¡æ—¶æœºä¼šï¼</p>
        <button class="btn-primary">ç«‹å³å‚ä¸</button>
      </div>
    </div>
  </div>

  <!-- éšè—æŒ‰é’®ï¼ˆæ”¯ä»˜/æ–°å»º/ç¼–è¾‘ï¼‰ -->
  <button id="btn-open-pay" style="display:none"
    onclick="window.open('member-buy.html','_blank','width=400,height=500,left=200,top=100')"></button>
  <button id="btn-open-new" style="display:none"
    onclick="window.open('custom-goal.html','_blank','width=400,height=420,left=200,top=100')"></button>
  <button id="btn-open-edit" style="display:none"
    onclick="window.open('custom-goal.html?edit='+this.dataset.gid,'_blank','width=400,height=420,left=200,top=100')"></button>

  <!-- ä¸»è„šæœ¬ -->
  <script type="module">
    import { supabase } from './js/supabase.js';
    import { getUser, logout } from './js/auth.js';
    import { getMyCustomGoals, deleteCustomGoal } from './js/custom.js';

    /* -------- ç»Ÿä¸€æ¸²æŸ“å¤´åƒ -------- */
    const avatar = document.getElementById('user-avatar');
    async function renderAuth(){
      const user = await getUser();
      if(user){
        avatar.src = user.avatar_url || 'images/default-avatar.png';
        avatar.onclick = () => toggleUserPopup(user);
      }else{
        avatar.src = 'images/default-avatar.png';
        avatar.onclick = async () => {
          await supabase.auth.signInWithOAuth({
            provider:'github',
            options:{ redirectTo: location.origin + location.pathname }
          });
        };
      }
      avatar.style.display = 'block';
    }
    // å¦‚æœæ˜¯åˆšå›è°ƒå›æ¥ï¼Œç«‹å³æ¢å–ä¼šè¯å¹¶åˆ·æ–°
    if(location.hash.includes('access_token') || location.search.includes('code')){
      await supabase.auth.getSession();
      location.replace(location.pathname);
    }
    await renderAuth();

    /* -------- æ¸²æŸ“å¡ç‰‡ï¼ˆç³»ç»Ÿè€ƒè¯• + è‡ªå®šä¹‰ï¼‰ -------- */
    const grid = document.querySelector('.entry-grid');

    // 1. ç³»ç»Ÿè€ƒè¯•ï¼ˆä¿è¯ moment å°±ç»ªï¼‰
    await import('./js/moment.min.js');
    await import('./js/moment-timezone-with-data-10-year-range.min.js');
    const { exams } = await import('./js/exams.js');
    function renderCountdownEntries() {
      const now = moment.tz('Asia/Shanghai');
      const sorted = [...exams].sort((a,b)=> moment(a.date).diff(now) - moment(b.date).diff(now));
      sorted.forEach(exam=>{
        const diff = moment(exam.date).diff(now);
        const div = document.createElement('div');
        div.className='entry-item' + (diff<=0 ? ' entry-ended' : '');
        div.innerHTML=`
          ${diff<=0?'<div class="overlay"></div><div class="ended-badge">å·²ç»“æŸ</div>':''}
          <img src="${exam.image}" class="entry-image">
          <h3 class="entry-title">${exam.name}</h3>`;
        div.onclick=()=> location.href=`countdown.html?id=${exam.id}`;
        grid.appendChild(div);
      });
    }
    renderCountdownEntries();

    // 2. å·²åˆ›å»ºçš„è‡ªå®šä¹‰ç›®æ ‡
    const user = await getUser();
    const list = await getMyCustomGoals();
    list.forEach(g => renderCustomGoalCard(g));

    // 3. â€œ+â€å¡ç‰‡ï¼ˆå§‹ç»ˆæ˜¾ç¤ºï¼‰
    const plus = document.createElement('div');
    plus.className='entry-item custom-plus';
    plus.innerHTML=`<img src="images/plus.svg" class="entry-image"><h3 class="entry-title">è‡ªå®šä¹‰ç›®æ ‡</h3>`;
    plus.onclick=()=>{
      if(!user){ avatar.click(); return; }
      if(!user.is_member){ document.getElementById('btn-open-pay').click(); return; }
      document.getElementById('btn-open-new').click();
    };
    grid.appendChild(plus);

    /* -------- è¾…åŠ©å‡½æ•° -------- */
    function renderCustomGoalCard(g){
      const item=document.createElement('div');
      item.className='entry-item custom-goal';
      item.style.position='relative';
      item.innerHTML=`
        <img src="images/custom-plus.jpg" class="entry-image">
        <h3 class="entry-title">${g.name}</h3>
        <i class="edit-icon" style="display:none;position:absolute;top:6px;left:6px;background:rgba(0,0,0,.5);color:#fff;border-radius:3px;padding:2px 4px;font-size:12px;cursor:pointer">âœï¸</i>
        <i class="del-icon"  style="display:none;position:absolute;top:6px;right:6px;background:rgba(0,0,0,.5);color:#fff;border-radius:3px;padding:2px 4px;font-size:12px;cursor:pointer">ğŸ—‘ï¸</i>`;
      item.onclick=()=> location.href=`countdown.html?custom=${g.id}`;
      item.onmouseenter=()=> item.querySelectorAll('i').forEach(i=>i.style.display='inline-block');
      item.onmouseleave=()=> item.querySelectorAll('i').forEach(i=>i.style.display='none');
      item.querySelector('.edit-icon').onclick=e=>{
        e.stopPropagation();
        const btn=document.getElementById('btn-open-edit');
        btn.dataset.gid=g.id;
        btn.click();
      };
      item.querySelector('.del-icon').onclick=async e=>{
        e.stopPropagation();
        if(!confirm('ç¡®å®šåˆ é™¤ï¼Ÿ')) return;
        await deleteCustomGoal(g.id);
        location.reload();
      };
      grid.appendChild(item);
    }

    /* -------- ç”¨æˆ·å°å¼¹çª— -------- */
    function toggleUserPopup(user){
      const pop=document.createElement('div');
      pop.id='user-popup';
      pop.style.cssText='position:absolute;right:12px;top:52px;width:240px;background:#fff;border-radius:8px;box-shadow:0 4px 20px rgba(0,0,0,.15);font-size:14px;z-index:999;overflow:hidden';
      pop.innerHTML=`
        <div style="padding:16px;display:flex;align-items:center;border-bottom:1px solid #f0f0f0">
          <img src="${user.avatar_url||'images/default-avatar.png'}" style="width:40px;height:40px;border-radius:50%;margin-right:12px">
          <div>
            <div style="font-weight:500">${user.username||'ç”¨æˆ·'}</div>
            <div style="font-size:12px;color:#666">${user.is_member?(user.member_plan==='month'?'åŸºç¡€ç‰ˆ':'å°Šäº«ç‰ˆ')+'ä¼šå‘˜':'æ™®é€šç”¨æˆ·'}</div>
          </div>
        </div>
        <div style="padding:12px 16px;font-size:12px;color:#666">${user.is_member?'å°†äº '+Math.ceil((new Date(user.member_expires_at)-Date.now())/86400000)+' å¤©ååˆ°æœŸ':'å¼€é€šä¼šå‘˜ç«‹äº«æƒç›Š'}</div>
        <div style="display:flex;border-top:1px solid #f0f0f0">
          <button id="popup-buy" style="flex:1;height:36px;border:none;background:#4a6bff;color:#fff;font-size:14px;cursor:pointer">${user.is_member?'ç»­è´¹':'å¼€é€š'}</button>
          <button id="popup-out" style="flex:1;height:36px;border:none;background:#fff;color:#ff4d4f;font-size:14px;cursor:pointer">é€€å‡ºç™»å½•</button>
        </div>`;
      document.body.appendChild(pop);
      pop.querySelector('#popup-buy').onclick=()=> document.getElementById('btn-open-pay').click();
      pop.querySelector('#popup-out').onclick=async()=>{await logout(); location.reload();};
      const close=e=>{if(!e.target.closest('#user-popup')){pop.remove(); document.removeEventListener('click',close);}};
      setTimeout(()=>document.addEventListener('click',close),0);
    }
</script>

    /* -------- æ´»åŠ¨å¼¹çª—å…³é—­ -------- */
    document.querySelectorAll('.close-modal').forEach(btn=>{
      btn.onclick=()=> btn.closest('.modal').style.display='none';
    });
    window.onclick=e=>{
      document.querySelectorAll('.modal').forEach(m=>{if(e.target===m) m.style.display='none';});
    };
  </script>
</body>
</html>