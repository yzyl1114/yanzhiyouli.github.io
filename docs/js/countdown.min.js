import{exams as e}from"./exams.js";import{supabase as t}from"./supabase.js";import{getUser as n}from"./auth.js";const o=[{id:"bg1",url:"images/bg1.jpg"},{id:"bg2",url:"images/bg2.jpg"},{id:"bg3",url:"images/bg3.jpg"},{id:"bg4",url:"images/bg4.jpg"},{id:"bg5",url:"images/bg5.jpg"},{id:"bg6",url:"images/bg6.jpg"},{id:"bg7",url:"images/bg7.jpg"},{id:"bg8",url:"images/bg8.jpg"},{id:"bg9",url:"images/bg9.jpg"},{id:"bg10",url:"images/bg10.jpg"},{id:"bg11",url:"images/bg11.jpg"},{id:"bg12",url:"images/bg12.jpg"},{id:"bg13",url:"images/bg13.jpg"},{id:"bg14",url:"images/bg14.jpg"},{id:"bg15",url:"images/bg15.jpg"},{id:"bg16",url:"images/bg16.jpg"},{id:"bg17",url:"images/bg17.jpg"},{id:"bg18",url:"images/bg18.jpg"},{id:"bg19",url:"images/bg19.jpg"},{id:"bg20",url:"images/bg20.jpg"},{id:"bg21",url:"images/bg21.jpg"},{id:"bg22",url:"images/bg22.jpg"},{id:"bg23",url:"images/bg23.jpg"},{id:"bg24",url:"images/bg24.jpg"}];function a(t){return e.find(e=>e.id===t)}function i(e){const t=(new Date).getTime(),n=new Date(e).getTime()-t;if(n<=0)return void["days","hours","minutes","seconds"].forEach(e=>document.getElementById(e).textContent="00");const o=Math.floor(n/864e5),a=Math.floor(n%864e5/36e5),i=Math.floor(n%36e5/6e4),r=Math.floor(n%6e4/1e3);document.getElementById("days").textContent=String(o).padStart(2,"0"),document.getElementById("hours").textContent=String(a).padStart(2,"0"),document.getElementById("minutes").textContent=String(i).padStart(2,"0"),document.getElementById("seconds").textContent=String(r).padStart(2,"0")}function r(e){const t=new Date(e);return`${t.getFullYear()}年${String(t.getMonth()+1).padStart(2,"0")}月${String(t.getDate()).padStart(2,"0")}日 ${String(t.getHours()).padStart(2,"0")}时${String(t.getMinutes()).padStart(2,"0")}分`}async function g(){const e=new URLSearchParams(window.location.search),t=e.get("custom"),g=e.get("id");let s=null;try{if(t){const e=await n();if(!e)throw new Error("用户未登录");const o=await fetch(`/api/custom-goals?user_id=${encodeURIComponent(e.id)}&openid=${encodeURIComponent(e.openid)}`);if(!o.ok)throw new Error(`HTTP ${o.status}: ${await o.text()}`);const a=await o.json();if(!a.success)throw new Error(a.error||"获取目标失败");const i=a.data.find(e=>e.id===t);if(!i)throw new Error("自定义目标不存在");s={name:i.name,date:i.date}}else if(g){const e=parseInt(g);if(s=a(e),!s)throw new Error("系统考试不存在")}else s=a(1);document.getElementById("exam-title").textContent=s.name,document.getElementById("exam-time").textContent=r(s.date),i(s.date),setInterval(()=>i(s.date),1e3);const e=localStorage.getItem("countdownBg")||"bg1",c=o.find(t=>t.id===e);c&&(document.getElementById("countdown-bg").style.backgroundImage=`url(${c.url})`),d(),l();const m=document.querySelector(".settings-entry");m&&(m.style.display="block")}catch(e){e.message;document.body.innerHTML=`\n      <div style="padding: 20px; text-align: center;">\n        <h2>页面加载失败</h2>\n        <p>${e.message}</p>\n        <button onclick="window.location.href='index.html'" style="padding: 10px 20px; margin: 10px;">返回首页</button>\n        <button onclick="location.reload()" style="padding: 10px 20px; margin: 10px;">重新加载</button>\n      </div>\n    `}}function d(){const e=document.getElementById("settings-modal"),t=document.querySelector(".settings-entry"),a=document.querySelector(".settings-modal .close-modal");t&&t.addEventListener("click",()=>{const t=localStorage.getItem("countdownBg")||"bg1";document.querySelectorAll(".bg-option").forEach(e=>{if(e.classList.remove("active"),e.dataset.bg===t){e.classList.add("active");document.querySelector(".background-options-container")&&setTimeout(()=>{e.scrollIntoView({behavior:"smooth",block:"center",inline:"center"})},100)}}),e.style.display="flex"}),a&&a.addEventListener("click",()=>{e.style.display="none"}),e.addEventListener("click",t=>{t.target===e&&(e.style.display="none")}),document.querySelector(".background-options-container").addEventListener("click",async t=>{t.stopPropagation();let a=t.target.closest(".bg-option");if(!a)return;const i=a.dataset.bg;if(["bg5","bg6","bg7","bg8","bg9","bg10","bg11","bg12","bg13","bg14","bg15","bg16","bg17","bg18","bg19","bg20","bg21","bg22","bg23","bg24"].includes(i)){const e=await n();if(e){const t=new Date;e.member_expires_at&&new Date(e.member_expires_at),localStorage.getItem("user_membership")}if(!e)return s("请先点击首页头像登录"),void setTimeout(()=>{window.location.href="index.html"},2e3);if(!e.is_member)return void window.open("member-buy.html","_blank","width=400,height=500,left=200,top=100")}const r=o.find(e=>e.id===i);r&&(document.getElementById("countdown-bg").style.backgroundImage=`url(${r.url})`,localStorage.setItem("countdownBg",i),document.querySelectorAll(".bg-option").forEach(e=>e.classList.remove("active")),a.classList.add("active"),e.style.display="none")}),document.querySelector(".background-options-container").addEventListener("wheel",e=>{e.stopPropagation()})}function s(e){const t=document.createElement("div");t.style.cssText="\n    position: fixed;\n    top: 50%;\n    left: 50%;\n    transform: translate(-50%, -50%);\n    background: rgba(0, 0, 0, 0.8);\n    color: white;\n    padding: 15px 25px;\n    border-radius: 8px;\n    z-index: 10000;\n    font-size: 16px;\n    text-align: center;\n    max-width: 300px;\n    animation: fadeInOut 2s ease-in-out;\n  ",t.textContent=e;const n=document.createElement("style");n.textContent="\n    @keyframes fadeInOut {\n      0% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }\n      20% { opacity: 1; transform: translate(-50%, -50%) scale(1); }\n      80% { opacity: 1; transform: translate(-50%, -50%) scale(1); }\n      100% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }\n    }\n  ",document.head.appendChild(n),document.body.appendChild(t),setTimeout(()=>{t.parentNode&&t.parentNode.removeChild(t),n.parentNode&&n.parentNode.removeChild(n)},2e3)}function l(){const e=document.querySelector(".ad-container"),t=document.getElementById("ad-close");e&&(e.style.display="block"),t&&t.addEventListener("click",()=>{e&&(e.style.display="none"),setTimeout(()=>{e&&(e.style.display="block")},6e5)})}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",g):g(),top!==self&&(top.location=self.location);