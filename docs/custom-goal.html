<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <title>自定义目标</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box;}
    body{font-family:PingFang SC,Helvetica;background:#f5f5f5;display:flex;justify-content:center;align-items:center;height:100vh}
    .box{background:#fff;width:400px;border-radius:12px;box-shadow:0 8px 30px rgba(0,0,0,.12);overflow:hidden}
    .header{height:56px;display:flex;align-items:center;justify-content:center;font-size:18px;font-weight:500;border-bottom:1px solid #f0f0f0}
    .body{padding:24px}
    .body input,.body select{width:100%;height:40px;border:1px solid #ddd;border-radius:6px;margin-bottom:16px;padding:0 12px;font-size:14px}
    .btns{display:flex;gap:12px}
    .btns button{flex:1;height:40px;border:none;border-radius:6px;font-size:15px;cursor:pointer}
    .save{background:#4a6bff;color:#fff}
    .cancel{background:#f0f0f0;color:#333}
    .date-row{display:flex;gap:12px;margin-bottom: 16px;}
    .date-row input{flex:1;height: 40px;border: 1px solid #ddd;border-radius: 6px;padding: 0 12px;font-size: 14px;display: block !important; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
</head>
<body>
  <div class="box">
    <div class="header" id="title">新建自定义目标</div>
    <div class="body">
      <input id="name" placeholder="目标名称（最多10字）" maxlength="10">
      <div class="date-row">
        <input type="date" id="date">
        <input type="time" id="time">
      </div>
      <select id="category">
        <option value="exam">考试</option>
        <option value="work">工作</option>
        <option value="life">生活</option>
        <option value="other">其他</option>
      </select>
      <div class="btns">
        <button class="cancel" onclick="window.location.href='index.html'">取消</button>
        <button class="save" id="confirm">保存</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { getUser } from './js/auth.js'
    import { createCustomGoal, updateCustomGoal, getMyCustomGoals } from './js/custom.js'
    const url=new URLSearchParams(location.search)
    const editId=url.get('edit')
    let goal=null
    const user=await getUser()
    if(!user){alert('请先登录');window.open('index.html','_self')}
    if(editId){
      const list=await getMyCustomGoals()
      goal=list.find(g=>g.id===editId)
      if(!goal){alert('目标不存在');window.open('index.html','_self')}
      document.getElementById('title').textContent='编辑自定义目标'
      document.getElementById('name').value=goal.name
      const d=dayjs(goal.date)
      document.getElementById('date').value=d.format('YYYY-MM-DD')
      document.getElementById('time').value=d.format('HH:mm')
      document.getElementById('category').value=goal.category
    }else{
      const d=dayjs().add(1,'day').hour(9).minute(0)
      document.getElementById('date').value=d.format('YYYY-MM-DD')
      document.getElementById('time').value=d.format('HH:mm')
    }
    document.getElementById('confirm').onclick=async()=>{
      const name=document.getElementById('name').value.trim()
      const date=document.getElementById('date').value
      const time=document.getElementById('time').value
      const category=document.getElementById('category').value
      if(!name){alert('请输入目标名称');return}
      const dt=dayjs(date+' '+time)
      if(dt.isBefore(dayjs())){alert('请选择未来的时间');return}
      if(goal) await updateCustomGoal(goal.id,{name,date:dt.toISOString(),category})
      else await createCustomGoal({name,date:dt.toISOString(),category})
      window.opener?.location?.reload?window.opener.location.reload():null
      window.open('index.html','_self')
    }
  </script>
</body>
</html>