<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GoalCountdown - 考试倒计时</title>
  <link rel="stylesheet" href="css/style.css">

  <!-- 时区库 -->
  <script src="js/moment.min.js"></script>
  <script src="js/moment-timezone-with-data-10-year-range.min.js"></script>

  <!-- 谷歌广告 -->
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7268374810307592" crossorigin="anonymous"></script>

  <!-- 今天北京时间 -->
  <script>
    function setTodayBJ(){
      const weekdays = ["日","一","二","三","四","五","六"];
      const bj = moment.tz("Asia/Shanghai");
      const str = `${bj.year()}年${bj.month()+1}月${bj.date()}日，星期${weekdays[bj.day()]}`;
      document.addEventListener('DOMContentLoaded', ()=>{
        document.getElementById('current-date').textContent = str;
      });
    }
    setTodayBJ();
  </script>
</head>

<body>
  <!-- 标题栏 -->
  <header class="header">
  <div class="logo-container">
    <img src="images/logo.png" alt="GoalCountdown Logo" class="logo">
    <h1>GoalCountdown</h1>
  </div>
  <div class="date-container" style="margin-left: auto; margin-right: 4px;">
    <span id="current-date">2025年01月01日，星期三</span>
  </div>
  <!-- 统一头像入口 -->
  <div id="user-bar-container"></div>
  </header>

  <!-- Banner -->
  <section class="banner">
    <img src="images/banner.jpg" alt="考试倒计时网站宣传" class="banner-image">
  </section>

  <!-- 倒计时入口 -->
  <section class="countdown-entries">
    <div class="entry-grid"></div>
  </section>

  <!-- 备案 -->
  <footer class="footer">
    <div class="beian">
      <a href="https://beian.mps.gov.cn/#/query/webSearch?code=11010502057033" target="_blank" rel="noreferrer">
        <img src="images/beian.png" alt="公安联网备案图标"> 京公网安备11010502057033号
      </a>
      <a href="http://beian.miit.gov.cn/" target="_blank" rel="noreferrer">京ICP备2024094021号</a>
    </div>
    <div class="contact">
      <span>商务合作 goalcountdown@gmail.com</span>
    </div>
  </footer>

  <!-- 活动弹窗 -->
  <div class="modal activity-modal" id="activity-modal">
    <div class="modal-content">
      <span class="close-modal">&times;</span>
      <h2 class="modal-title">新用户专享活动</h2>
      <div class="modal-body">
        <p>注册即送3次自定义倒计时机会！</p>
        <button class="btn-primary">立即参与</button>
      </div>
    </div>
  </div>

  <!-- 隐藏按钮（支付/新建/编辑） -->
  <button id="btn-open-pay" style="display:none"
    onclick="window.open('member-buy.html','_blank','width=400,height=500,left=200,top=100')"></button>
  <button id="btn-open-new" style="display:none"
    onclick="window.open('custom-goal.html','_blank','width=400,height=420,left=200,top=100')"></button>
  <button id="btn-open-edit" style="display:none"
    onclick="window.open('custom-goal.html?edit='+this.dataset.gid,'_blank','width=400,height=420,left=200,top=100')"></button>

  <!-- 主脚本 -->
  <script type="module">
      import { supabase } from './js/supabase.js';
      import { getUser, logout } from './js/auth.js';
      import { getMyCustomGoals, deleteCustomGoal } from './js/custom.js';
      import { exams } from './js/exams.js';

      // 修复：正确处理微信登录回调
      async function handleAuthCallback() {
        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get('code');
    
        console.log('URL 参数:', Object.fromEntries(urlParams));
    
        if (code) {
            console.log('handleAuthCallback: 检测到code，但应该已被main函数处理');
            return true;
        }
        return false;
      }

      // 用户小弹窗功能
      function toggleUserPopup(user) {
          console.log('显示用户弹窗');
          
          // 先移除已存在的弹窗
          const existingPopup = document.getElementById('user-popup');
          if (existingPopup) {
              existingPopup.remove();
              return;
          }
          
          const pop = document.createElement('div');
          pop.id = 'user-popup';
          pop.style.cssText = 'position:absolute;right:12px;top:52px;width:220px;background:#fff;border-radius:8px;box-shadow:0 4px 20px rgba(0,0,0,.15);font-size:14px;z-index:999;overflow:hidden';
          pop.innerHTML = `
              <div style="padding:16px;display:flex;align-items:center;border-bottom:1px solid #f0f0f0">
              <img src="${user.avatar_url||'images/default-avatar.png'}" style="width:40px;height:40px;border-radius:50%;margin-right:12px">
              <div style="flex:1">
                  <div style="font-weight:500">${user.username||'用户'}</div>
                  <div style="font-size:12px;color:#666">${user.is_member?(user.member_plan==='month'?'基础版':'尊享版')+'会员':'普通用户'}</div>
              </div>
              </div>
              <div style="padding:12px 16px;font-size:12px;color:#666;display:flex;justify-content:space-between;align-items:center">
              <span>${user.is_member?'将于 '+Math.ceil((new Date(user.member_expires_at)-Date.now())/86400000)+' 天后到期':'开通会员立享权益'}</span>
              ${!user.is_member?'<span id="popup-buy" style="color:#4a6bff;cursor:pointer">开通</span>':''}
              </div>
              <div style="border-top:1px solid #f0f0f0;padding:8px;text-align:center">
              <button id="popup-out" style="border:none;background:none;color:#ff4d4f;font-size:13px;cursor:pointer">退出登录</button>
              </div>`;
          document.body.appendChild(pop);
          
          // 绑定事件
          if (!user.is_member) {
              pop.querySelector('#popup-buy').onclick = (e) => {
                  e.stopPropagation();
                  document.getElementById('btn-open-pay').click();
                  pop.remove();
              };
          }
          
          pop.querySelector('#popup-out').onclick = async (e) => {
              e.stopPropagation();
              await logout(); 
              location.reload();
          };
          
          // 点击外部关闭弹窗
          const closePopup = (e) => {
              if (!e.target.closest('#user-popup') && !e.target.closest('.user-bar')) {
                  pop.remove();
                  document.removeEventListener('click', closePopup);
              }
          };
          setTimeout(() => document.addEventListener('click', closePopup), 0);
      }

      // 渲染用户栏函数
      function renderUserBar(user) {
          const container = document.getElementById('user-bar-container');
          if (!container) {
              console.error('用户栏容器不存在');
              return;
          }

          console.log('渲染用户栏，用户状态:', user);
          
          // 清空容器
          container.innerHTML = '';

          const wrap = document.createElement('div');
          wrap.className = 'user-bar';
          wrap.style.cssText = `
              margin-left: auto;
              margin-right: 20px;
              cursor: pointer;
              display: flex;
              align-items: center;
              gap: 10px;
          `;

          if (user) {
              // 已登录用户
              let userStatus = '普通用户';
              let statusStyle = 'color: #666; font-size: 12px;';
              
              if (user.is_member) {
                  userStatus = user.member_plan === 'month' ? '基础版会员' : '尊享版会员';
                  statusStyle = 'color: #4a6bff; font-size: 12px;';
              }
              
              wrap.innerHTML = `
                  <img src="${user.avatar_url || 'images/default-avatar.png'}" 
                      style="width:40px;height:40px;border-radius:50%;border: 2px solid ${user.is_member ? '#4a6bff' : '#ddd'};">
              `;
                // 点击头像显示用户弹窗
              wrap.onclick = (e) => {
                  e.stopPropagation();
                  console.log('点击用户头像');
                  toggleUserPopup(user);
              };

              console.log('✅ 已登录用户栏渲染完成');
          } else {
              // 未登录用户
              wrap.innerHTML = `
                  <img src="images/default-avatar.png" 
                      style="width:40px;height:40px;border-radius:50%;border: 2px solid #ddd;">
              `;
              // 点击事件 - 微信登录
              wrap.onclick = (e) => {
                  e.stopPropagation();
                  console.log('点击登录按钮');
                  // 微信扫码登录
                  window.location.href='https://open.weixin.qq.com/connect/qrconnect?appid=wxd4e5f7a42fa74524&redirect_uri=' + encodeURIComponent('https://goalcountdown.com/api/wechat-login') + '&response_type=code&scope=snsapi_login&state=123#wechat_redirect';
              };
              console.log('✅ 未登录用户栏渲染完成');
          }
          
          container.appendChild(wrap);
          console.log('用户栏已添加到容器');
      }

      // 主执行流程
      async function main() {
          console.log('开始主流程...');
          // 先处理支付成功
          handlePaymentSuccess();
          
          // 🔥 关键修复：检查登录重定向参数
          const urlParams = new URLSearchParams(window.location.search);
          const loginSuccess = urlParams.get('login_success');
          const userData = urlParams.get('user_data');
          const loginError = urlParams.get('login_error');
          const code = urlParams.get('code');
        
          console.log('URL参数:', { loginSuccess, userData: userData ? '有数据' : '无', loginError, code });
        
          // 情况1：处理登录成功重定向
          if (loginSuccess === 'true' && userData) {
              console.log('🔥 检测到登录成功重定向');
              try {
                  const userInfo = JSON.parse(decodeURIComponent(userData));
                  console.log('登录成功，用户信息:', userInfo);
                
                  // 保存用户信息
                  localStorage.setItem('user_info', JSON.stringify(userInfo));
                
                  // 清除URL参数
                  const cleanUrl = window.location.origin + window.location.pathname;
                  window.history.replaceState({}, document.title, cleanUrl);
                
                  console.log('✅ 用户信息已保存，刷新页面');
                  location.reload();
                  return;
              } catch (error) {
                  console.error('解析用户数据失败:', error);
              }
          }
        
          // 情况2：处理登录错误
          if (loginError) {
              const errorMsg = decodeURIComponent(loginError);
              console.error('登录失败:', errorMsg);
              alert('登录失败: ' + errorMsg);
            
              // 清除错误参数
              const cleanUrl = window.location.origin + window.location.pathname;
              window.history.replaceState({}, document.title, cleanUrl);
          }
        
          // 情况3：如果还有code参数，说明后端没有正确重定向
          if (code) {
              console.log('⚠️ 检测到code参数，但后端应该已重定向。清除参数继续...');
              const cleanUrl = window.location.origin + window.location.pathname;
              window.history.replaceState({}, document.title, cleanUrl);
          }      
          
          // 处理认证回调
          const isHandlingCallback = await handleAuthCallback();
          if (isHandlingCallback) {
              return;
          }
          
          // 获取用户信息
          const user = await getUser();
          console.log('用户信息:', user);
          
          // 关键修复：合并本地会员状态到用户信息
          const userWithMembership = await mergeLocalMembership(user);
          console.log('合并后的用户信息:', userWithMembership);
            
          // 渲染用户栏 - 使用合并后的用户信息
          renderUserBar(userWithMembership);
          
          /* ---- 渲染卡片 ---- */
          const grid = document.querySelector('.entry-grid');
          if (!grid) {
              console.error('找不到 .entry-grid 元素');
              return;
          }

          // 1. 系统考试（必现）
          function renderCountdownEntries(){
              const now = moment.tz('Asia/Shanghai');
              const sorted = [...exams].sort((a,b)=> moment(a.date).diff(now) - moment(b.date).diff(now));
              sorted.forEach(exam=>{
                  const diff = moment(exam.date).diff(now);
                  const div = document.createElement('div');
                  div.className='entry-item' + (diff<=0 ? ' entry-ended' : '');
                  div.innerHTML=`
                      ${diff<=0?'<div class="overlay"></div><div class="ended-badge">已结束</div>':''}
                      <img src="${exam.image}" class="entry-image">
                      <h3 class="entry-title">${exam.name}</h3>`;
                  div.onclick=()=> location.href=`countdown.html?id=${exam.id}`;
                  grid.appendChild(div);
              });
          }
          renderCountdownEntries();

          // 2. 已创建的自定义目标
          if (user) {
              try {
                  const list = await getMyCustomGoals();
                  list.forEach(g => renderCustomGoalCard(g));
              } catch (error) {
                  console.error('获取自定义目标失败:', error);
              }
          }

          // 3. 「+」卡片（始终显示）
          const plus = document.createElement('div');
          plus.className='entry-item custom-plus';
          plus.innerHTML=`<img src="images/plus.svg" class="entry-image"><h3 class="entry-title">自定义目标</h3>`;
          plus.onclick=async (e)=>{
              e.stopPropagation();
              console.log('点击自定义目标，用户状态:', userWithMembership);
              if(!userWithMembership){ 
                  // 触发登录
                  const userBar = document.querySelector('.user-bar');
                  if (userBar) userBar.click(); 
                  return; 
              }

              // 🔥 关键修复：检查会员状态（包括本地会员）
              const isMember = userWithMembership.is_member || 
                              (userWithMembership.local_membership && userWithMembership.member_plan);

              if(!isMember){ 
                  console.log('非会员，打开会员购买页');
                  document.getElementById('btn-open-pay').click(); 
                  return; 
              }
              
              // 检查目标数量限制
              const currentGoals = await getMyCustomGoals();
              const memberPlan = userWithMembership.member_plan || 'month';
              const maxGoals = memberPlan === 'month' ? 3 : 5;  // ✅ 正确：使用 memberPlan
                    
              console.log(`当前目标数: ${currentGoals.length}, 最大限制: ${maxGoals}, 会员类型: ${memberPlan}`);              
              
              if (currentGoals.length >= maxGoals) {
                  if (user.member_plan === 'month') {
                      alert('升级尊享版会员，创建更多目标');
                      document.getElementById('btn-open-pay').click();
                  } else {
                      alert('自定义目标已达最多限制，可删除旧目标后新建');
                  }
                  return;
              }
              
              console.log('会员，打开新建目标');
              document.getElementById('btn-open-new').click();
          };
          grid.appendChild(plus);

          console.log('主流程完成');
      }

        // 新增：合并本地会员状态函数
      async function mergeLocalMembership(user) {
          if (!user) return user;
            
          try {
              const localMembership = localStorage.getItem('user_membership');
              if (localMembership) {
                  const membership = JSON.parse(localMembership);
                  console.log('发现本地会员状态:', membership);
                    
                  if (membership.isMember && new Date(membership.expires) > new Date()) {
                        // 本地会员状态有效
                      return {
                          ...user,
                          is_member: true,
                          member_plan: membership.plan,
                          member_expires_at: membership.expires,
                          local_membership: true // 标记为本地会员
                      };
                  } else {
                        // 本地会员已过期，清理
                      localStorage.removeItem('user_membership');
                      console.log('清理过期的本地会员状态');
                  }
              }
          } catch (error) {
              console.error('合并本地会员状态失败:', error);
          }
            
          return user;
      }

      // 辅助函数 - 渲染自定义目标卡片
      function renderCustomGoalCard(g){
          const grid = document.querySelector('.entry-grid');
          if (!grid) return;
          
          const item=document.createElement('div');
          item.className='entry-item custom-goal';
          item.style.position='relative';
          
          // 根据分类选择图片
          let imageSrc = 'images/custom-plus.jpg'; // 默认图片
          switch(g.category) {
              case 'work':
                  imageSrc = 'images/work.png';
                  break;
              case 'life':
                  imageSrc = 'images/life.png';
                  break;
              case 'other':
                  imageSrc = 'images/others.png';
                  break;
              case 'exam':
              default:
                  imageSrc = 'images/custom-plus.jpg';
          }
          
          item.innerHTML=`
              <img src="${imageSrc}" class="entry-image" onerror="this.src='images/custom-plus.jpg'">
              <h3 class="entry-title">${g.name}</h3>
              <div class="custom-goal-actions" style="display:none;position:absolute;top:6px;right:6px;display:flex;gap:4px;">
                  <i class="edit-icon" style="background:rgba(0,0,0,.5);color:#fff;border-radius:3px;padding:2px 4px;font-size:12px;cursor:pointer">✏️</i>
                  <i class="del-icon" style="background:rgba(0,0,0,.5);color:#fff;border-radius:3px;padding:2px 4px;font-size:12px;cursor:pointer">🗑️</i>
              </div>`;
          item.onclick=()=> location.href=`countdown.html?custom=${g.id}`;
          item.onmouseenter=()=> item.querySelector('.custom-goal-actions').style.display='flex';
          item.onmouseleave=()=> item.querySelector('.custom-goal-actions').style.display='none';
          item.querySelector('.edit-icon').onclick=e=>{
              e.stopPropagation();
              const btn=document.getElementById('btn-open-edit');
              btn.dataset.gid=g.id;
              btn.click();
          };
          item.querySelector('.del-icon').onclick=async e=>{
              e.stopPropagation();
              if(!confirm('确定删除？')) return;
              try {
                  await deleteCustomGoal(g.id);
                  alert('已删除');
                  location.reload();
              } catch (error) {
                  alert('删除失败，请重试');
              }
          };
          grid.appendChild(item);
      }
      // 添加支付成功处理
      function handlePaymentSuccess() {
          const urlParams = new URLSearchParams(window.location.search);
          const paymentSuccess = urlParams.get('payment') === 'success' || 
                          localStorage.getItem('payment_success') === 'true';
        
          if (paymentSuccess) {
              console.log('检测到支付成功，刷新用户状态');
            
              // 清理支付成功标记
              localStorage.removeItem('payment_success');
              localStorage.removeItem('payment_plan');
              localStorage.removeItem('payment_timestamp');
            
              // 清除URL参数，避免重复触发
              if (urlParams.get('payment') === 'success') {
                  const cleanUrl = window.location.origin + window.location.pathname;
                  window.history.replaceState({}, document.title, cleanUrl);
              }
            
              // 显示成功提示并强制刷新页面应用会员权限
              setTimeout(() => {
                  alert('会员开通成功！欢迎使用会员功能。');
                  // 强制刷新以确保会员权限生效
                  location.reload();
              }, 500);
          }
      }
      // 启动主流程
      main().catch(console.error);
  </script>