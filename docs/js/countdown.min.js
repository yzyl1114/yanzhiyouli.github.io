import{exams}from"./exams.js";import{supabase}from"./js/supabase.js";import{getUser}from"./js/auth.js";let currentExamId=parseInt(new URLSearchParams(window.location.search).get("id"))||1;const backgroundImages=[{id:"bg1",url:"images/bg1.jpg"},{id:"bg2",url:"images/bg2.jpg"},{id:"bg3",url:"images/bg3.jpg"},{id:"bg4",url:"images/bg4.jpg"},{id:"bg5",url:"images/bg5.jpg"},{id:"bg6",url:"images/bg6.jpg"}];function getExamDataById(id){return exams.find(exam=>exam.id===id)}function updateCountdownDisplay(exam){const now=moment().tz("Asia/Shanghai");const examTime=moment(exam.date);const diff=examTime.diff(now);if(diff<=0){document.getElementById("days").textContent="00";document.getElementById("hours").textContent="00";document.getElementById("minutes").textContent="00";document.getElementById("seconds").textContent="00";return}const duration=moment.duration(diff);const days=String(Math.floor(duration.asDays())).padStart(2,"0");const hours=String(duration.hours()).padStart(2,"0");const minutes=String(duration.minutes()).padStart(2,"0");const seconds=String(duration.seconds()).padStart(2,"0");document.getElementById("days").textContent=days;document.getElementById("hours").textContent=hours;document.getElementById("minutes").textContent=minutes;document.getElementById("seconds").textContent=seconds}function formatExamTime(exam){const examTime=moment(exam.date);return`${examTime.format("YYYY年MM月DD日")} ${examTime.format("HH:mm")}`}async function initCountdownPage(){const urlParams=new URLSearchParams(location.search);const customId=urlParams.get("custom");let exam;if(customId){const{data:data,error:error}=await supabase.from("custom_goals").select("*").eq("id",customId).single();if(error||!data){location.href="index.html";return}exam={name:data.name,date:data.date}}else{exam=getExamDataById(currentExamId);if(!exam){location.href="index.html";return}}document.getElementById("exam-title").textContent=exam.name;document.getElementById("exam-time").textContent=window.dayjs(exam.date).format("YYYY年MM月DD日 HH:mm");updateCountdownDisplay(exam);setInterval(()=>updateCountdownDisplay(exam),1e3);const bgSetting=localStorage.getItem("countdownBg")||"bg1";document.getElementById("countdown-bg").style.backgroundImage=`url(${getBackgroundUrl(bgSetting)})`;initSettingsModal();showAdContainer();document.querySelector(".settings-entry").style.display="block"}function getBackgroundUrl(bgId){const bg=backgroundImages.find(bg=>bg.id===bgId);if(!bg){console.error(`Background image with id ${bgId} not found.`);return"images/default-bg.jpg"}return bg.url}function initSettingsModal(){const settingsModal=document.getElementById("settings-modal");document.querySelector(".settings-entry").addEventListener("click",()=>{settingsModal.style.display="flex"});document.querySelector(".settings-modal .close-modal").addEventListener("click",()=>{settingsModal.style.display="none"});document.querySelectorAll(".bg-option").forEach(option=>{option.addEventListener("click",async()=>{const bgId=option.dataset.bg;if(["bg5","bg6"].includes(bgId)){const user=await getUser();if(!user||!user.is_member){window.open("member-buy.html","_blank","width=400,height=500,left=200,top=100");return}}const bgUrl=getBackgroundUrl(bgId);document.getElementById("countdown-bg").style.backgroundImage=`url(${bgUrl})`;localStorage.setItem("countdownBg",bgId);document.querySelectorAll(".bg-option").forEach(opt=>opt.classList.remove("active"));option.classList.add("active")})});window.addEventListener("click",e=>{if(e.target===settingsModal){settingsModal.style.display="none"}})}function showAdContainer(){const adContainer=document.querySelector(".ad-container");adContainer.style.display="block";document.getElementById("ad-close").addEventListener("click",()=>{adContainer.style.display="none";setTimeout(()=>{adContainer.style.display="block"},6e5)})}document.addEventListener("DOMContentLoaded",initCountdownPage);if(top!==self){top.location=self.location}