<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <title>å¼€é€šä¼šå‘˜</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box;}
    body{font-family:PingFang SC,Helvetica;background:#f5f5f5;display:flex;justify-content:center;align-items:center;height:100vh}
    .box{background:#fff;width:420px;border-radius:12px;box-shadow:0 8px 30px rgba(0,0,0,.12);overflow:hidden}
    .header{height:56px;display:flex;align-items:center;justify-content:center;font-size:18px;font-weight:500;border-bottom:1px solid #f0f0f0}
    .cards{display:flex;gap:16px;padding:24px}
    .card{flex:1;border:2px solid #e0e0e0;border-radius:8px;padding:16px;cursor:pointer;transition:all 0.3s ease;background:#fff}
    .card.month:hover, .card.halfyear:hover{border-color:#4a6bff;transform:translateY(-2px)}
    .card.month.active{border-color:#4a6bff !important;background:#f6f9ff !important;box-shadow:0 0 0 2px #4a6bff}
    .card.halfyear.active{border-color:#ff6a00 !important;background:#fff9f0 !important;box-shadow:0 0 0 2px #ff6a00}
    .card h3{font-size:16px;margin-bottom:4px}
    .card small{font-size:12px;color:#666}
    .agreement{display:flex;align-items:center;margin-bottom:16px;font-size:13px;color:#666}
    .agreement-checkbox{width:16px;height:16px;margin-right:8px;cursor:pointer}
    .agreement-text{line-height:1.4}
    .agreement-link{color:#4a6bff;cursor:pointer;text-decoration:none}
    .agreement-link:hover{text-decoration:underline}
    .row{display:flex;justify-content:space-between;font-size:13px;margin-top:8px}
    .foot{padding:0 24px 24px}
    #pay-btn{width:100%;height:40px;border:none;border-radius:6px;background:#07c160;color:#fff;font-size:15px;cursor:pointer}
    #pay-btn:disabled{background:#cccccc;cursor:not-allowed}
    #qrcode{width:80px;height:80px;margin:12px auto;display:block}
    #tip{text-align:center;font-size:12px;color:#4a6bff;cursor:pointer;margin-top:6px}
    .cancel{text-align:center;font-size:12px;color:#999;margin-top:12px;cursor:pointer}
  </style>
  <script type="module" src="js/member.js"></script>
</head>
<body>
  <div class="box">
    <div class="header">å¼€é€šä¼šå‘˜</div>
    <div class="cards">
      <div class="card month" data-plan="month">
        <h3>åŸºç¡€ç‰ˆ</h3><small>90 å¤©ä¼šå‘˜</small>
        <div class="row"><span>ä¼šå‘˜ä¸“å±èƒŒæ™¯å›¾</span><span>âœ…</span></div>
        <div class="row"><span>è‡ªå®šä¹‰å€’è®¡æ—¶äº‹ä»¶</span><span>âœ…</span></div>
        <div class="row"><span>ä¿å­˜æ•°é‡</span><span>3 ä¸ª</span></div>
      </div>
      <div class="card halfyear" data-plan="halfyear">
        <h3>å°Šäº«ç‰ˆ</h3><small>360 å¤©ä¼šå‘˜</small>
        <div class="row"><span>ä¼šå‘˜ä¸“å±èƒŒæ™¯å›¾</span><span>âœ…</span></div>
        <div class="row"><span>è‡ªå®šä¹‰å€’è®¡æ—¶äº‹ä»¶</span><span>âœ…</span></div>
        <div class="row"><span>ä¿å­˜æ•°é‡</span><span>5 ä¸ª</span></div>
      </div>
    </div>
    <div class="foot">
      <div class="agreement">
            <input type="checkbox" id="agreement-checkbox" class="agreement-checkbox" checked>
            <label for="agreement-checkbox" class="agreement-text">
              æˆ‘å·²é˜…è¯»å¹¶åŒæ„<a class="agreement-link" href="agreement/member-agreement.html" target="_blank">ã€Šä¼šå‘˜æœåŠ¡åè®®ã€‹</a>
            </label>
          </div>
      <button id="pay-btn">æ”¯ä»˜å®æ”¯ä»˜</button>
      <img id="qrcode" style="display:none">
      <div id="tip" style="display:none">æˆ‘å·²æ”¯ä»˜</div>
      <div class="cancel" onclick="window.close()">å–æ¶ˆ</div>
    </div>
  </div>

  <script type="module">
      // âœ… ä¿®æ­£å¯¼å…¥è¯­å¥
      import { getCurrentUser, createAlipayOrder, pollAlipayOrder } from './js/member.js'
        
      let plan = 'month', orderId

      // åˆå§‹åŒ–é¡µé¢ - ç®€åŒ–ç‰ˆæœ¬
      async function initPage() {
          try {
              console.log('å¼€å§‹åˆå§‹åŒ–æ”¯ä»˜é¡µé¢...')
            
              // ç­‰å¾…é¡µé¢å®Œå…¨åŠ è½½
              await new Promise(resolve => setTimeout(resolve, 100))
            
              const user = await getCurrentUser()
              console.log('å½“å‰ç”¨æˆ·çŠ¶æ€:', user)

              // æ¸…é™¤æ‰€æœ‰å¡ç‰‡çš„activeçŠ¶æ€
              document.querySelectorAll('.card').forEach(x => x.classList.remove('active'))
            
              // æ™ºèƒ½é»˜è®¤é€‰æ‹©é€»è¾‘
              if (user && user.is_member) {
                  // ä¼šå‘˜è¿›å…¥æ”¯ä»˜é¡µ â†’ é»˜è®¤é€‰ä¸­å°Šäº«ç‰ˆï¼ˆç”¨äºå‡çº§æˆ–ç»­è´¹ï¼‰
                  plan = 'halfyear'
                  const halfyearCard = document.querySelector('.card.halfyear')
                  if (halfyearCard) {
                      halfyearCard.classList.add('active')
                      console.log('ä¼šå‘˜ç”¨æˆ·ï¼Œé»˜è®¤é€‰æ‹©å°Šäº«ç‰ˆ')
                  }
              } else {
                  // éä¼šå‘˜ â†’ é»˜è®¤é€‰æ‹©åŸºç¡€ç‰ˆ
                  plan = 'month'
                  const monthCard = document.querySelector('.card.month')
                  if (monthCard) {
                      monthCard.classList.add('active')
                      console.log('éä¼šå‘˜ç”¨æˆ·ï¼Œé»˜è®¤é€‰æ‹©åŸºç¡€ç‰ˆ')
                  }
              }
            
              updatePayButtonText()
              updatePayButtonState()

              console.log('åˆå§‹åŒ–å®Œæˆ - å½“å‰é€‰ä¸­è®¡åˆ’:', plan)
              console.log('æ¿€æ´»çš„å¡ç‰‡:', document.querySelector('.card.active'))
            
          } catch (error) {
              console.error('åˆå§‹åŒ–é¡µé¢å¤±è´¥:', error)
              plan = 'month'
              const monthCard = document.querySelector('.card.month')
              if (monthCard) monthCard.classList.add('active')
              updatePayButtonText()
              updatePayButtonState()
          }
      }

      // âœ… ä¿®æ­£é‡‘é¢æ˜¾ç¤º
      function updatePayButtonText() {
          const payBtn = document.getElementById('pay-btn')
          if (plan === 'month') {
              payBtn.textContent = 'Â¥6 æ”¯ä»˜å®æ”¯ä»˜'
          } else {
              payBtn.textContent = 'Â¥19 æ”¯ä»˜å®æ”¯ä»˜'
          }
      }

      function updatePayButtonState() {
          const payBtn = document.getElementById('pay-btn')
          const agreementCheckbox = document.getElementById('agreement-checkbox')
        
          if (agreementCheckbox.checked) {
              payBtn.disabled = false
          } else {
              payBtn.disabled = true
          }
      }

      // å¡ç‰‡é€‰æ‹©äº‹ä»¶
      document.querySelectorAll('.card').forEach(c => c.onclick = () => {
          document.querySelectorAll('.card').forEach(x => x.classList.remove('active'))
          c.classList.add('active')
          plan = c.dataset.plan
          console.log('é€‰æ‹©å¥—é¤:', plan)
          updatePayButtonText()
      })

      // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
      document.addEventListener('DOMContentLoaded', async () => {
          console.log('DOMåŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–...')
          await initPage()
      })

      setTimeout(async () => {
          const activeCard = document.querySelector('.card.active')
          if (!activeCard) {
              console.log('å»¶è¿Ÿæ£€æŸ¥ï¼šæœªæ£€æµ‹åˆ°æ¿€æ´»å¡ç‰‡ï¼Œé‡æ–°åˆå§‹åŒ–...')
              await initPage()
          }
      }, 300)

      document.getElementById('agreement-checkbox').addEventListener('change', function() {
          updatePayButtonState()
      })      

      // æ”¯ä»˜æŒ‰é’®ç‚¹å‡»äº‹ä»¶
      document.getElementById('pay-btn').onclick = async () => {
          try {
              const agreementCheckbox = document.getElementById('agreement-checkbox')
              if (!agreementCheckbox.checked) {
                  alert('è¯·å…ˆé˜…è¯»å¹¶åŒæ„ä¼šå‘˜æœåŠ¡åè®®')
                  return
              }        
        
              console.log('=== æ”¯ä»˜å®æ”¯ä»˜æµç¨‹å¼€å§‹ ===');
              console.log('å½“å‰è®¡åˆ’:', plan);
        
              const result = await createAlipayOrder(plan)
              console.log('æ”¯ä»˜å®è®¢å•åˆ›å»ºç»“æœ:', result)

              if (!result || !result.success || !result.data) {
                  console.error('æ”¯ä»˜å®è®¢å•åˆ›å»ºå¤±è´¥:', result)
                  alert('åˆ›å»ºè®¢å•å¤±è´¥: ' + (result?.error || 'æœªçŸ¥é”™è¯¯'))
                  return
              }
        
              const { order_id, form_data } = result.data
              orderId = order_id
        
              console.log('æ”¯ä»˜å®è®¢å•ID:', orderId);
              console.log('åŸå§‹è¡¨å•æ•°æ®:', form_data);
        
              // ğŸ”¥ ä¿®å¤ï¼šæ­£ç¡®å¤„ç†æ”¯ä»˜å®è¿”å›çš„æŸ¥è¯¢å­—ç¬¦ä¸²
              if (form_data) {
                  console.log('å¤„ç†æ”¯ä»˜å®æ”¯ä»˜è¡¨å•...');
                
                  // æ–¹æ³•1ï¼šç›´æ¥æ„å»ºå®Œæ•´çš„URLè¿›è¡Œè·³è½¬ï¼ˆæ¨èï¼‰
                  const payUrl = `https://openapi.alipay.com/gateway.do?${form_data}`;
                  console.log('å®Œæ•´æ”¯ä»˜URL:', payUrl);
                
                  // ç›´æ¥è·³è½¬åˆ°æ”¯ä»˜å®æ”¯ä»˜é¡µé¢
                  window.location.href = payUrl;
                
              } else {
                  console.error('æ”¯ä»˜å®è¿”å›æ•°æ®æ ¼å¼ä¸æ”¯æŒ:', result.data);
                  alert('æ”¯ä»˜æ–¹å¼æš‚ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•');
              }
        
          } catch (error) {
              console.error('æ”¯ä»˜å®æ”¯ä»˜æµç¨‹å¼‚å¸¸:', error)
              alert('æ”¯ä»˜å¤±è´¥: ' + error.message)
          }
      }
    
      // "æˆ‘å·²æ”¯ä»˜"æŒ‰é’®ç‚¹å‡»äº‹ä»¶
      document.getElementById('tip').onclick = async () => {
          if (!orderId) {
              alert('æ²¡æœ‰æ‰¾åˆ°è®¢å•ä¿¡æ¯')
              return
          }
        
          console.log('æ‰‹åŠ¨æ£€æŸ¥æ”¯ä»˜å®æ”¯ä»˜çŠ¶æ€ï¼Œè®¢å•ID:', orderId)
          // âœ… ä½¿ç”¨ä» member.js å¯¼å…¥çš„å‡½æ•°
          const paid = await pollAlipayOrder(orderId, plan)
        
          if (paid) {
              const membershipName = plan === 'month' ? 'åŸºç¡€ç‰ˆ' : 'å°Šäº«ç‰ˆ'
              alert(`æ”¯ä»˜æˆåŠŸï¼æ‚¨å·²æˆä¸º${membershipName}ä¼šå‘˜`)
              performRedirect()
          } else {
              alert('æš‚æœªæ£€æµ‹åˆ°æ”¯ä»˜ï¼Œè¯·ç¨å€™æˆ–åˆ·æ–°é¡µé¢é‡è¯•')
          }
      }

      // âŒ åˆ é™¤è¿™é‡Œé‡å¤å®šä¹‰çš„ createAlipayOrder å’Œ pollAlipayOrder å‡½æ•°

      function performRedirect() {
          console.log('æ‰§è¡Œé¡µé¢è·³è½¬...');
        
          localStorage.setItem('payment_success', 'true');
          localStorage.setItem('payment_plan', plan);
          localStorage.setItem('payment_timestamp', new Date().toISOString());
        
          if (document.referrer && document.referrer.includes(location.hostname)) {
              console.log('è¿”å›ä¸Šä¸€é¡µ:', document.referrer);
              window.location.href = './index.html';
          } else {
              console.log('è·³è½¬åˆ°é¦–é¡µ');
              window.location.href = './index.html';
          }
      }
  </script>
</body>
</html>