<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GoalCountdown - è€ƒè¯•å€’è®¡æ—¶</title>
    <link rel="stylesheet" href="css/style.css">
    <!-- å¼•ç”¨æœ¬åœ°å­˜å‚¨çš„è„šæœ¬æ–‡ä»¶ -->
    <script src="js/moment.min.js"></script>
    <script src="js/moment-timezone-with-data-10-year-range.min.js"></script>
    <script type="module" src="js/auth.js"></script>
    <!-- è°·æ­Œå¹¿å‘Šå®¡æ ¸ä»£ç  -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7268374810307592"crossorigin="anonymous"></script>
</head>
<body>
    <!-- æ ‡é¢˜æ  -->
    <header class="header">
        <div class="logo-container">
            <img src="images/logo.png" alt="GoalCountdown Logo" class="logo">
            <h1>GoalCountdown</h1>
        </div>
        <div class="date-container" style="margin-left:auto;margin-right:20px;">
            <span id="current-date">2025å¹´01æœˆ01æ—¥ï¼Œæ˜ŸæœŸä¸‰</span>
        </div>

        <!-- æ–°å¢ç™»å½•æŒ‰é’® -->
        <!-- æ›¿æ¢åŸæ¥çš„ <button id="btn-login"...> -->
        <img id="user-avatar" src="images/default-avatar.png" style="width:30px;height:30px;border-radius:50%;margin-left:auto;margin-right:20px;cursor:pointer;display:none;">
    </header>

    <!-- Banner -->
    <section class="banner">
        <img src="images/banner.jpg" alt="è€ƒè¯•å€’è®¡æ—¶ç½‘ç«™å®£ä¼ " class="banner-image">
    </section>

    <!-- å€’è®¡æ—¶å…¥å£ -->
    <section class="countdown-entries">
        <div class="entry-grid">
            <!-- åŠ¨æ€ç”Ÿæˆçš„å€’è®¡æ—¶å…¥å£å°†é€šè¿‡JSæ’å…¥ -->
        </div>
    </section>

    <!-- å¤‡æ¡ˆåŠè”ç³»æ–¹å¼ -->
    <footer class="footer">
        <div class="beian">
            <a href="https://beian.mps.gov.cn/#/query/webSearch?code=11010502057033" target="_blank" rel="noreferrer">
                <img src="images/beian.png" alt="å…¬å®‰è”ç½‘å¤‡æ¡ˆå›¾æ ‡"> äº¬å…¬ç½‘å®‰å¤‡11010502057033å·
            </a>
            <a href="http://beian.miit.gov.cn/" target="_blank" rel="noreferrer">äº¬ICPå¤‡2024094021å·</a>
        </div>
        <div class="contact">
            <span>å•†åŠ¡åˆä½œ goalcountdown@gmail.com</span>
        </div>
    </footer>

    <!-- æ´»åŠ¨å¼¹çª— -->
    <div class="modal activity-modal" id="activity-modal">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <h2 class="modal-title">æ–°ç”¨æˆ·ä¸“äº«æ´»åŠ¨</h2>
            <div class="modal-body">
                <p>æ³¨å†Œå³é€3æ¬¡è‡ªå®šä¹‰å€’è®¡æ—¶æœºä¼šï¼</p>
                <button class="btn-primary">ç«‹å³å‚ä¸</button>
            </div>
        </div>
    </div>

    <!-- ç™»å½•é€»è¾‘ï¼ˆæ¨¡å—è„šæœ¬ï¼‰ -->
    <script type="module">
      import { supabase } from './js/supabase.js';
      import { getUser, logout } from './js/auth.js';
      import { getMyCustomGoals, deleteCustomGoal } from './js/custom.js';

      /* -------- ç»Ÿä¸€æ¸²æŸ“å¤´åƒ -------- */
      const avatar = document.getElementById('user-avatar');
      async function renderAuth(){
        const user = await getUser();
        if(user){
          avatar.src = user.avatar_url || 'images/default-avatar.png';
          avatar.onclick = () => toggleUserPopup(user);
        }else{
          avatar.src = 'images/default-avatar.png';
          avatar.onclick = () => supabase.auth.signInWithOAuth({
            provider:'github',
            options:{ redirectTo: location.origin + location.pathname }
          });
        }
        avatar.style.display = 'block';
      }
      await renderAuth();

      /* -------- æ¸²æŸ“å¡ç‰‡ï¼ˆæ— è®ºæ˜¯å¦ç™»å½•ï¼‰ -------- */
      const grid = document.querySelector('.entry-grid');

      /* 1. ç³»ç»Ÿè€ƒè¯•å…¥å£ï¼ˆè°ƒç”¨ä½ åŸæœ‰å‡½æ•°å³å¯ï¼‰ */
      renderCountdownEntries();   // ä½ ä¹‹å‰å·²æœ‰çš„å‡½æ•°ï¼Œä¿æŒä¸åŠ¨

      /* 2. å·²åˆ›å»ºçš„è‡ªå®šä¹‰ç›®æ ‡ */
      const user = await getUser(); // å†æ‹¿ä¸€æ¬¡ä¼šå‘˜çŠ¶æ€
      const list = await getMyCustomGoals();
      list.forEach(g => renderCustomGoalCard(g));

      /* 3. â€œ+â€å¡ç‰‡ï¼ˆå§‹ç»ˆæ˜¾ç¤ºï¼‰ */
      const plus = document.createElement('div');
      plus.className = 'entry-item custom-plus';
      plus.innerHTML = `<img src="images/plus.svg" class="entry-image"><h3 class="entry-title">è‡ªå®šä¹‰ç›®æ ‡</h3>`;
      plus.onclick = () => {
        if (!user) { avatar.click(); return; }          // æœªç™»å½•â†’ç™»å½•
        if (!user.is_member) {                          // éä¼šå‘˜â†’æ”¯ä»˜
          document.getElementById('btn-open-pay').click();
          return;
        }
        document.getElementById('btn-open-new').click(); // ä¼šå‘˜â†’æ–°å»º
      };
      grid.appendChild(plus);

      /* -------- è¾…åŠ©å‡½æ•° -------- */
      function renderCustomGoalCard(g){
        const item = document.createElement('div');
        item.className = 'entry-item custom-goal';
        item.style.position = 'relative';
        item.innerHTML = `
          <img src="images/custom-plus.jpg" class="entry-image">
          <h3 class="entry-title">${g.name}</h3>
          <i class="edit-icon" style="display:none;position:absolute;top:6px;left:6px;background:rgba(0,0,0,.5);color:#fff;border-radius:3px;padding:2px 4px;font-size:12px;cursor:pointer">âœï¸</i>
          <i class="del-icon"  style="display:none;position:absolute;top:6px;right:6px;background:rgba(0,0,0,.5);color:#fff;border-radius:3px;padding:2px 4px;font-size:12px;cursor:pointer">ğŸ—‘ï¸</i>
        `;
        item.onclick = () => location.href = `countdown.html?custom=${g.id}`;
        item.onmouseenter = () => { item.querySelectorAll('i').forEach(i=>i.style.display='inline-block'); };
        item.onmouseleave = () => { item.querySelectorAll('i').forEach(i=>i.style.display='none'); };
        item.querySelector('.edit-icon').onclick = e => {
          e.stopPropagation();
          const btn = document.getElementById('btn-open-edit');
          btn.dataset.gid = g.id;
          btn.click();
        };
        item.querySelector('.del-icon').onclick = async e => {
          e.stopPropagation();
          if (!confirm('ç¡®å®šåˆ é™¤ï¼Ÿ')) return;
          await deleteCustomGoal(g.id);
          location.reload();
        };
        grid.appendChild(item);
      }
    </script>
</body>
</html>