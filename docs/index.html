<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GoalCountdown - 考试倒计时</title>
  <link rel="stylesheet" href="css/style.css">

  <!-- 时区库 -->
  <script src="js/moment.min.js"></script>
  <script src="js/moment-timezone-with-data-10-year-range.min.js"></script>

  <!-- 谷歌广告 -->
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7268374810307592" crossorigin="anonymous"></script>

  <!-- 今天北京时间 -->
  <script>
    function setTodayBJ(){
      const weekdays = ["日","一","二","三","四","五","六"];
      const bj = moment.tz("Asia/Shanghai");
      const str = `${bj.year()}年${bj.month()+1}月${bj.date()}日，星期${weekdays[bj.day()]}`;
      document.addEventListener('DOMContentLoaded', ()=>{
        document.getElementById('current-date').textContent = str;
      });
    }
    setTodayBJ();
  </script>
</head>

<body>
  <!-- 标题栏 -->
  <header class="header">
  <div class="logo-container">
    <img src="images/logo.png" alt="GoalCountdown Logo" class="logo">
    <h1>GoalCountdown</h1>
  </div>
  <div class="date-container" style="margin-left: auto; margin-right: 4px;">
    <span id="current-date">2025年01月01日，星期三</span>
  </div>
  <!-- 统一头像入口 -->
  <img id="user-avatar" src="images/default-avatar.png" style="width:30px;height:30px;border-radius:50%;cursor:pointer;display:none;">
  </header>

  <!-- Banner -->
  <section class="banner">
    <img src="images/banner.jpg" alt="考试倒计时网站宣传" class="banner-image">
  </section>

  <!-- 倒计时入口 -->
  <section class="countdown-entries">
    <div class="entry-grid"></div>
  </section>

  <!-- 备案 -->
  <footer class="footer">
    <div class="beian">
      <a href="https://beian.mps.gov.cn/#/query/webSearch?code=11010502057033" target="_blank" rel="noreferrer">
        <img src="images/beian.png" alt="公安联网备案图标"> 京公网安备11010502057033号
      </a>
      <a href="http://beian.miit.gov.cn/" target="_blank" rel="noreferrer">京ICP备2024094021号</a>
    </div>
    <div class="contact">
      <span>商务合作 goalcountdown@gmail.com</span>
    </div>
  </footer>

  <!-- 活动弹窗 -->
  <div class="modal activity-modal" id="activity-modal">
    <div class="modal-content">
      <span class="close-modal">&times;</span>
      <h2 class="modal-title">新用户专享活动</h2>
      <div class="modal-body">
        <p>注册即送3次自定义倒计时机会！</p>
        <button class="btn-primary">立即参与</button>
      </div>
    </div>
  </div>

  <!-- 隐藏按钮（支付/新建/编辑） -->
  <button id="btn-open-pay" style="display:none"
    onclick="window.open('member-buy.html','_blank','width=400,height=500,left=200,top=100')"></button>
  <button id="btn-open-new" style="display:none"
    onclick="window.open('custom-goal.html','_blank','width=400,height=420,left=200,top=100')"></button>
  <button id="btn-open-edit" style="display:none"
    onclick="window.open('custom-goal.html?edit='+this.dataset.gid,'_blank','width=400,height=420,left=200,top=100')"></button>

  <!-- 主脚本 -->
  <script type="module">
      import { supabase } from './js/supabase.js';
      import { getUser, logout } from './js/auth.js';
      import { getMyCustomGoals, deleteCustomGoal } from './js/custom.js';
      import { exams } from './js/exams.js';

      /* ---- 统一头像 ---- */
      const avatar = document.getElementById('user-avatar');
      async function renderAuth(){
          const user = await getUser();
          console.log('用户信息:', user); // 调试信息
          
          if(user){
              avatar.src = user.avatar_url || 'images/default-avatar.png';
              // 修复：确保点击事件正确绑定
              avatar.onclick = (e) => {
                  e.stopPropagation();
                  console.log('点击头像，用户已登录');
                  toggleUserPopup(user);
              };
          }else{
              avatar.src = 'images/default-avatar.png';
              // 未登录用户点击头像执行登录
              avatar.onclick = (e) => {
                  e.stopPropagation();
                  console.log('点击头像，用户未登录');
                    // ===== 微信扫码登录（正式环境）=====
                  window.location.href='https://open.weixin.qq.com/connect/qrconnect?appid=wxd4e5f7a42fa74524&redirect_uri=' + encodeURIComponent('https://goalcountdown.com/api/wechat-login') + '&response_type=code&scope=snsapi_login&state=123#wechat_redirect';
                };
          }
          avatar.style.display = 'block';
          return user;
      }

      // 如果是刚回调回来，立即换取会话并刷新
      if(location.hash.includes('access_token') || location.search.includes('code')){
          await supabase.auth.getSession();
          location.replace(location.pathname);
      }
      
      const user = await renderAuth();
      console.log('最终用户状态:', user); // 调试信息

      /* ---- 渲染卡片 ---- */
      const grid = document.querySelector('.entry-grid');

      // 1. 系统考试（必现）
      function renderCountdownEntries(){
          const now = moment.tz('Asia/Shanghai');
          const sorted = [...exams].sort((a,b)=> moment(a.date).diff(now) - moment(b.date).diff(now));
          sorted.forEach(exam=>{
              const diff = moment(exam.date).diff(now);
              const div = document.createElement('div');
              div.className='entry-item' + (diff<=0 ? ' entry-ended' : '');
              div.innerHTML=`
                  ${diff<=0?'<div class="overlay"></div><div class="ended-badge">已结束</div>':''}
                  <img src="${exam.image}" class="entry-image">
                  <h3 class="entry-title">${exam.name}</h3>`;
              div.onclick=()=> location.href=`countdown.html?id=${exam.id}`;
              grid.appendChild(div);
          });
      }
      renderCountdownEntries();

      // 2. 已创建的自定义目标
      const list = await getMyCustomGoals();
      list.forEach(g => renderCustomGoalCard(g));

      // 3. 「+」卡片（始终显示）
      const plus = document.createElement('div');
      plus.className='entry-item custom-plus';
      plus.innerHTML=`<img src="images/plus.svg" class="entry-image"><h3 class="entry-title">自定义目标</h3>`;
      plus.onclick=async (e)=>{
          e.stopPropagation();
          console.log('点击自定义目标，用户状态:', user);
          if(!user){ 
              avatar.click(); 
              return; 
          }
          if(!user.is_member){ 
              console.log('非会员，打开会员购买页');
              document.getElementById('btn-open-pay').click(); 
              return; 
          }
          
          // 检查目标数量限制
          const currentGoals = await getMyCustomGoals();
          const maxGoals = user.member_plan === 'month' ? 3 : 5;
          
          console.log(`当前目标数: ${currentGoals.length}, 最大限制: ${maxGoals}, 会员类型: ${user.member_plan}`);
          
          if (currentGoals.length >= maxGoals) {
              if (user.member_plan === 'month') {
                  alert('升级尊享版会员，创建更多目标');
                  document.getElementById('btn-open-pay').click();
              } else {
                  alert('自定义目标已达最多限制，可删除旧目标后新建');
              }
              return;
          }
          
          console.log('会员，打开新建目标');
          document.getElementById('btn-open-new').click();
      };
      grid.appendChild(plus);

      /* ---- 辅助函数 ---- */
      function renderCustomGoalCard(g){
          const item=document.createElement('div');
          item.className='entry-item custom-goal';
          item.style.position='relative';
          
          // 根据分类选择图片
          let imageSrc = 'images/custom-plus.jpg'; // 默认图片
          switch(g.category) {
              case 'work':
                  imageSrc = 'images/work.png';
                  break;
              case 'life':
                  imageSrc = 'images/life.png';
                  break;
              case 'other':
                  imageSrc = 'images/others.png';
                  break;
              case 'exam':
              default:
                  imageSrc = 'images/custom-plus.jpg';
          }
          
          item.innerHTML=`
              <img src="${imageSrc}" class="entry-image" onerror="this.src='images/custom-plus.jpg'">
              <h3 class="entry-title">${g.name}</h3>
              <div class="custom-goal-actions" style="display:none;position:absolute;top:6px;right:6px;display:flex;gap:4px;">
                  <i class="edit-icon" style="background:rgba(0,0,0,.5);color:#fff;border-radius:3px;padding:2px 4px;font-size:12px;cursor:pointer">✏️</i>
                  <i class="del-icon" style="background:rgba(0,0,0,.5);color:#fff;border-radius:3px;padding:2px 4px;font-size:12px;cursor:pointer">🗑️</i>
              </div>`;
          item.onclick=()=> location.href=`countdown.html?custom=${g.id}`;
          item.onmouseenter=()=> item.querySelector('.custom-goal-actions').style.display='flex';
          item.onmouseleave=()=> item.querySelector('.custom-goal-actions').style.display='none';
          item.querySelector('.edit-icon').onclick=e=>{
              e.stopPropagation();
              const btn=document.getElementById('btn-open-edit');
              btn.dataset.gid=g.id;
              btn.click();
          };
          item.querySelector('.del-icon').onclick=async e=>{
              e.stopPropagation();
              if(!confirm('确定删除？')) return;
              try {
                  await deleteCustomGoal(g.id);
                  alert('已删除');
                  location.reload();
              } catch (error) {
                  alert('删除失败，请重试');
              }
          };
          grid.appendChild(item);
      }

      /* ---- 用户小弹窗（新排版） ---- */
      function toggleUserPopup(user){
          console.log('显示用户弹窗');
          const pop=document.createElement('div');
          pop.id='user-popup';
          pop.style.cssText='position:absolute;right:12px;top:52px;width:220px;background:#fff;border-radius:8px;box-shadow:0 4px 20px rgba(0,0,0,.15);font-size:14px;z-index:999;overflow:hidden';
          pop.innerHTML=`
              <div style="padding:16px;display:flex;align-items:center;border-bottom:1px solid #f0f0f0">
              <img src="${user.avatar_url||'images/default-avatar.png'}" style="width:40px;height:40px;border-radius:50%;margin-right:12px">
              <div style="flex:1">
                  <div style="font-weight:500">${user.username||'用户'}</div>
                  <div style="font-size:12px;color:#666">${user.is_member?(user.member_plan==='month'?'基础版':'尊享版')+'会员':'普通用户'}</div>
              </div>
              </div>
              <div style="padding:12px 16px;font-size:12px;color:#666;display:flex;justify-content:space-between;align-items:center">
              <span>${user.is_member?'将于 '+Math.ceil((new Date(user.member_expires_at)-Date.now())/86400000)+' 天后到期':'开通会员立享权益'}</span>
              ${!user.is_member?'<span id="popup-buy" style="color:#4a6bff;cursor:pointer">开通</span>':''}
              </div>
              <div style="border-top:1px solid #f0f0f0;padding:8px;text-align:center">
              <button id="popup-out" style="border:none;background:none;color:#ff4d4f;font-size:13px;cursor:pointer">退出登录</button>
              </div>`;
          document.body.appendChild(pop);
          // 绑定事件
          if(!user.is_member) pop.querySelector('#popup-buy').onclick=()=> document.getElementById('btn-open-pay').click();
          pop.querySelector('#popup-out').onclick=async()=>{await logout(); location.reload();};
          const close=e=>{if(!e.target.closest('#user-popup')){pop.remove(); document.removeEventListener('click',close);}};
          setTimeout(()=>document.addEventListener('click',close),0);
      }

      // 在 index.html 的主脚本末尾添加
      async function checkAndCleanupExpiredMembership() {
          try {
              const user = await getUser()
              if (user && user.is_member && user.member_expires_at) {
                  const now = new Date()
                  const expiry = new Date(user.member_expires_at)
                  
                  if (expiry < now) {
                      console.log('检测到会员已过期，开始清理...')
                      
                      // 1. 更新数据库中的会员状态
                      const { error: updateError } = await supabase
                          .from('profiles')
                          .update({
                              is_member: false,
                              member_plan: null,
                              member_expires_at: null,
                              updated_at: new Date().toISOString()
                          })
                          .eq('id', user.id)
                      
                      if (updateError) {
                          console.error('更新会员状态失败:', updateError)
                          return
                      }
                      
                      // 2. 删除自定义目标
                      const { data: goals, error: goalsError } = await supabase
                          .from('custom_goals')
                          .select('id')
                          .eq('user_id', user.id)
                          
                      if (goalsError) {
                          console.error('查询自定义目标失败:', goalsError)
                          return
                      }
                      
                      if (goals && goals.length > 0) {
                          const { error: deleteError } = await supabase
                              .from('custom_goals')
                              .delete()
                              .eq('user_id', user.id)
                              
                          if (deleteError) {
                              console.error('删除自定义目标失败:', deleteError)
                          } else {
                              console.log(`已删除 ${goals.length} 个过期会员的自定义目标`)
                              // 刷新页面显示最新状态
                              location.reload()
                          }
                      }
                      
                      // 3. 清理本地存储
                      localStorage.removeItem('user_membership')
                      if (window.userMembership) {
                          window.userMembership = null
                      }
                      
                      console.log('会员过期清理完成')
                  }
              }
          } catch (error) {
              console.error('检查会员过期状态失败:', error)
          }
      }
      // 页面加载时检查
      checkAndCleanupExpiredMembership()
      // 每5分钟检查一次（生产环境可以调整频率）
      setInterval(checkAndCleanupExpiredMembership, 5 * 60 * 1000)

  </script>
</body>
</html>