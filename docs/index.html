<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GoalCountdown - 考试倒计时</title>
    <link rel="stylesheet" href="css/style.css">
    <!-- 引用本地存储的脚本文件 -->
    <script src="js/moment.min.js"></script>
    <script src="js/moment-timezone-with-data-10-year-range.min.js"></script>
    <script type="module" src="js/auth.js"></script>
    <!-- 谷歌广告审核代码 -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7268374810307592"crossorigin="anonymous"></script>
</head>
<body>
    <!-- 标题栏 -->
    <header class="header">
        <div class="logo-container">
            <img src="images/logo.png" alt="GoalCountdown Logo" class="logo">
            <h1>GoalCountdown</h1>
        </div>
        <div class="date-container" style="margin-left:auto;margin-right:20px;">
            <span id="current-date">2025年01月01日，星期三</span>
        </div>
        <div class="user-bar"></div>

        <!-- 新增登录按钮 -->
        <!-- 替换原来的 <button id="btn-login"...> -->
        <img id="user-avatar" src="images/default-avatar.png" style="width:30px;height:30px;border-radius:50%;margin-left:auto;margin-right:20px;cursor:pointer;display:none;">
    </header>

    <!-- Banner -->
    <section class="banner">
        <img src="images/banner.jpg" alt="考试倒计时网站宣传" class="banner-image">
    </section>

    <!-- 倒计时入口 -->
    <section class="countdown-entries">
        <div class="entry-grid">
            <!-- 动态生成的倒计时入口将通过JS插入 -->
        </div>
    </section>

    <!-- 备案及联系方式 -->
    <footer class="footer">
        <div class="beian">
            <a href="https://beian.mps.gov.cn/#/query/webSearch?code=11010502057033" target="_blank" rel="noreferrer">
                <img src="images/beian.png" alt="公安联网备案图标"> 京公网安备11010502057033号
            </a>
            <a href="http://beian.miit.gov.cn/" target="_blank" rel="noreferrer">京ICP备2024094021号</a>
        </div>
        <div class="contact">
            <span>商务合作 goalcountdown@gmail.com</span>
        </div>
    </footer>

    <!-- 活动弹窗 -->
    <div class="modal activity-modal" id="activity-modal">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <h2 class="modal-title">新用户专享活动</h2>
            <div class="modal-body">
                <p>注册即送3次自定义倒计时机会！</p>
                <button class="btn-primary">立即参与</button>
            </div>
        </div>
    </div>

    <!-- 登录逻辑（模块脚本） -->
    <script type="module">
      import { supabase } from './js/supabase.js';
      document.getElementById('btn-login').onclick = () =>
        supabase.auth.signInWithOAuth({ 
          provider: 'github',
          options: { redirectTo:'https://yzyl1114.github.io/yanzhiyouli.github.io/index.html' } 
        });
      import { getUser } from './js/auth.js';
      import { getMyCustomGoals, createCustomGoal, deleteCustomGoal } from './js/custom.js';

      (async () => {
        const user = await getUser();
        const grid = document.querySelector('.entry-grid');

        /* 1. 渲染已有自定义目标 */
        const list = await getMyCustomGoals();
        list.forEach(g => {
          const item = document.createElement('div');
          item.className = 'entry-item custom-goal';
          item.innerHTML = `
            <img src="images/custom-plus.jpg" class="entry-image">
            <h3 class="entry-title">${g.name}</h3>
            <i class="edit-icon" style="display:none;position:absolute;top:6px;left:6px;background:rgba(0,0,0,.5);color:#fff;border-radius:3px;padding:2px 4px;font-size:12px;cursor:pointer">✏️</i>
            <i class="del-icon"  style="display:none;position:absolute;top:6px;right:6px;background:rgba(0,0,0,.5);color:#fff;border-radius:3px;padding:2px 4px;font-size:12px;cursor:pointer">🗑️</i>
          `;
          item.style.position = 'relative';
          item.onclick = () => location.href = `countdown1004.html?custom=${g.id}`;
          item.onmouseenter = () => {
            item.querySelector('.edit-icon').style.display = 'inline-block';
            item.querySelector('.del-icon').style.display = 'inline-block';
          };
          item.onmouseleave = () => {
            item.querySelector('.edit-icon').style.display = 'none';
            item.querySelector('.del-icon').style.display = 'none';
          };
          item.querySelector('.edit-icon').onclick = e => {
            e.stopPropagation();
            const btn = document.getElementById('btn-open-edit');
            btn.dataset.gid = g.id;
            btn.click();
          };
          item.querySelector('.del-icon').onclick = async e => {
            e.stopPropagation();
            if (!confirm('确定删除？')) return;
            await deleteCustomGoal(g.id);   // ✅ 用封装函数
            location.reload();
          };
          grid.prepend(item);
        });

        /* 2. 始终显示“+”卡片，未登录=登录，非会员=支付 */
        const plus = document.createElement('div');
        plus.className = 'entry-item custom-plus';
        plus.innerHTML = `
          <img src="images/plus.svg" class="entry-image">
          <h3 class="entry-title">自定义目标</h3>`;
        plus.onclick = () => {
          if (!user) { avatar.click(); return; }          // 未登录→登录
          if (!user.is_member) {                          // 非会员→支付
            document.getElementById('btn-open-pay').click();
            return;
          }
          // 会员→新建
          document.getElementById('btn-open-new').click();
        };
        grid.appendChild(plus);   // 注意：用 appendChild 放最后
        })();
    </script>
    
    <!-- 禁用右键菜单和快捷键 -->
    <script>
        document.addEventListener('contextmenu', function(e) {
            e.preventDefault();
        });
        document.addEventListener('keydown', function(e) {
            if (e.key === 'F12' || (e.ctrlKey && e.shiftKey && e.key === 'I')) {
                e.preventDefault();
            }
        });
    </script>

    <!-- 引用本地存储的脚本文件 -->
    <script type="module" src="js/index.min.js"></script>

    <!-- ===== 1. 支付弹窗触发按钮（隐藏，仅代码调用） ===== -->
    <button id="btn-open-pay" style="display:none"
            onclick="window.open('member-buy.html','_blank','width=400,height=500,left=200,top=100')"></button>

    <!-- ===== 2. 新建目标触发按钮（隐藏） ===== -->
    <button id="btn-open-new" style="display:none"
            onclick="window.open('custom-goal.html','_blank','width=400,height=420,left=200,top=100')"></button>

    <!-- ===== 3. 编辑目标触发按钮（隐藏） ===== -->
    <button id="btn-open-edit" style="display:none"
            onclick="window.open('custom-goal.html?edit='+this.dataset.gid,'_blank','width=400,height=420,left=200,top=100')"></button>

    <!-- ===== 4. 用户小弹窗（开通/续费） ===== -->
    <script type="module">
      import { supabase } from './js/supabase.js';
      import { getUser, logout } from './js/auth.js';
      let user = await getUser();

      /* 一键渲染头像/登录 */
      async function renderAuthEntry(){
        const user = await getUser();
        const avatar = document.getElementById('user-avatar');
        if(user){
          avatar.src = user.avatar_url || 'images/default-avatar.png';
          avatar.style.display = 'block';
          avatar.onclick = () => toggleUserPopup(user); // 复用你已有的弹窗逻辑
        }else{
          avatar.style.display = 'block';  // 未登录也显示，点击即登录
          avatar.src = 'images/default-avatar.png';
          avatar.onclick = () => supabase.auth.signInWithOAuth({provider:'github'});
        }
      }
      renderAuthEntry();

      /* ---- 导航栏头像区域点击 ---- */
      document.addEventListener('click', e => {
        const ava = e.target.closest('.user-bar img');
        if (!ava) return;
        if (!user) return;                       // 未登录不弹
        const popup = document.createElement('div');
        popup.id = 'user-popup';
        popup.innerHTML = `
          <div style="position:absolute;right:20px;top:60px;background:#fff;border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,.15);padding:12px;font-size:14px;line-height:1.8;z-index:999";white-space: nowrap>
            <div>${user.username || '用户'}</div>
            <div style="color:#666">${user.is_member ? (user.member_plan==='month'?'基础版':'尊享版')+'会员' : '普通用户'}</div>
            <div style="color:#666">${user.is_member ? '将于 '+Math.ceil((new Date(user.member_expires_at)-Date.now())/86400000)+' 天后到期' : '开通会员立享权益'}</div>
            <button id="popup-buy" style="float:right;margin-top:-40px;height:24px;border:none;border-radius:4px;background:#4a6bff;color:#fff;font-size:12px;cursor:pointer">${user.is_member?'续费':'开通'}</button>
            <button id="popup-out" style="width:100%;margin-top:10px;border:none;background:none;color:#ff4d4f;cursor:pointer">退出登录</button>
          </div>`;
        document.body.appendChild(popup);
        popup.querySelector('#popup-buy').onclick = () => document.getElementById('btn-open-pay').click();
        popup.querySelector('#popup-out').onclick = async () => { await logout(); location.reload(); };
        const close = e => { if (!e.target.closest('#user-popup')) { popup.remove(); document.removeEventListener('click', close); } };
        setTimeout(() => document.addEventListener('click', close), 0);
      });
    </script>
</body>
</html>