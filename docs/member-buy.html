<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <title>开通会员</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box;}
    body{font-family:PingFang SC,Helvetica;background:#f5f5f5;display:flex;justify-content:center;align-items:center;height:100vh}
    .box{background:#fff;width:420px;border-radius:12px;box-shadow:0 8px 30px rgba(0,0,0,.12);overflow:hidden}
    .header{height:56px;display:flex;align-items:center;justify-content:center;font-size:18px;font-weight:500;border-bottom:1px solid #f0f0f0}
    .cards{display:flex;gap:16px;padding:24px}
    .card{flex:1;border:2px solid #e0e0e0;border-radius:8px;padding:16px;cursor:pointer;transition:all 0.3s ease;background:#fff}
    .card.month:hover, .card.halfyear:hover{border-color:#4a6bff;transform:translateY(-2px)}
    .card.month.active{border-color:#4a6bff !important;background:#f6f9ff !important;box-shadow:0 0 0 2px #4a6bff}
    .card.halfyear.active{border-color:#ff6a00 !important;background:#fff9f0 !important;box-shadow:0 0 0 2px #ff6a00}
    .card h3{font-size:16px;margin-bottom:4px}
    .card small{font-size:12px;color:#666}
    .row{display:flex;justify-content:space-between;font-size:13px;margin-top:8px}
    .foot{padding:0 24px 24px}
    #pay-btn{width:100%;height:40px;border:none;border-radius:6px;background:#07c160;color:#fff;font-size:15px;cursor:pointer}
    #qrcode{width:80px;height:80px;margin:12px auto;display:block}
    #tip{text-align:center;font-size:12px;color:#4a6bff;cursor:pointer;margin-top:6px}
    .cancel{text-align:center;font-size:12px;color:#999;margin-top:12px;cursor:pointer}
  </style>
  <script type="module" src="js/member.js"></script>
</head>
<body>
  <div class="box">
    <div class="header">开通会员</div>
    <div class="cards">
      <div class="card month" data-plan="month">
        <h3>基础版</h3><small>30 天会员</small>
        <div class="row"><span>会员专属背景图</span><span>✅</span></div>
        <div class="row"><span>自定义倒计时事件</span><span>✅</span></div>
        <div class="row"><span>保存数量</span><span>3 个</span></div>
      </div>
      <div class="card halfyear" data-plan="halfyear">
        <h3>尊享版</h3><small>180 天会员</small>
        <div class="row"><span>会员专属背景图</span><span>✅</span></div>
        <div class="row"><span>自定义倒计时事件</span><span>✅</span></div>
        <div class="row"><span>保存数量</span><span>5 个</span></div>
      </div>
    </div>
    <div class="foot">
      <button id="pay-btn">微信支付</button>
      <img id="qrcode" style="display:none">
      <div id="tip" style="display:none">我已支付</div>
      <div class="cancel" onclick="window.close()">取消</div>
    </div>
  </div>

  <script type="module">
      import { createOrder, pollOrder, getCurrentUser } from './js/member.js'
          
      let plan = 'month', orderId

      // 初始化页面 - 简化版本
      async function initPage() {
          try {
              console.log('开始初始化支付页面...')
              
              // 等待页面完全加载
              await new Promise(resolve => setTimeout(resolve, 100))
              
              const user = await getCurrentUser()
              console.log('当前用户状态:', user)
              
              // 检查用户是否登录
              if (!user) {
                  console.log('用户未登录，跳转到登录页面')
                  alert('请先登录后再开通会员')
                  window.location.href = './index.html' // 跳回首页登录
                  return
              }

              // 清除所有卡片的active状态
              document.querySelectorAll('.card').forEach(x => x.classList.remove('active'))
              
              // 智能默认选择逻辑
              if (user && user.is_member) {
                  // 会员进入支付页 → 默认选中尊享版（用于升级或续费）
                  plan = 'halfyear'
                  const halfyearCard = document.querySelector('.card.halfyear')
                  if (halfyearCard) {
                      halfyearCard.classList.add('active')
                      console.log('会员用户，默认选择尊享版')
                  }
              } else {
                  // 非会员 → 默认选择基础版
                  plan = 'month'
                  const monthCard = document.querySelector('.card.month')
                  if (monthCard) {
                      monthCard.classList.add('active')
                      console.log('非会员用户，默认选择基础版')
                  }
              }
              
              updatePayButtonText()
              
              // 添加视觉确认
              console.log('初始化完成 - 当前选中计划:', plan)
              console.log('激活的卡片:', document.querySelector('.card.active'))
              
          } catch (error) {
              console.error('初始化页面失败:', error)
              // 出错时默认选择基础版
              plan = 'month'
              const monthCard = document.querySelector('.card.month')
              if (monthCard) monthCard.classList.add('active')
              updatePayButtonText()
          }
      }

      // 更新支付按钮文案
      function updatePayButtonText() {
          const payBtn = document.getElementById('pay-btn')
          if (plan === 'month') {
              payBtn.textContent = '¥6 微信支付'
          } else {
              payBtn.textContent = '¥19 微信支付'
          }
      }

      // 卡片选择事件
      document.querySelectorAll('.card').forEach(c => c.onclick = () => {
          document.querySelectorAll('.card').forEach(x => x.classList.remove('active'))
          c.classList.add('active')
          plan = c.dataset.plan
          console.log('选择套餐:', plan)
          updatePayButtonText()
      })

      // 页面加载时初始化
      document.addEventListener('DOMContentLoaded', async () => {
          console.log('DOM加载完成，开始初始化...')
          await initPage()
      })

      // 备用初始化：延迟执行确保DOM完全就绪
      setTimeout(async () => {
          const activeCard = document.querySelector('.card.active')
          if (!activeCard) {
              console.log('延迟检查：未检测到激活卡片，重新初始化...')
              await initPage()
          }
      }, 300)
    
    // 支付按钮点击事件 - 修复版本
    document.getElementById('pay-btn').onclick = async () => {
      try {
        console.log('=== 支付流程开始 ===');
        console.log('当前计划:', plan);
        console.log('用户信息:', await getCurrentUser());
        console.log('开始创建订单，套餐:', plan)
        
        const result = await createOrder(plan)
        console.log('订单创建结果:', result)
        console.log('success 字段:', result?.success);
        console.log('data 字段:', result?.data);
        console.log('qrcode_url 字段:', result?.data?.qrcode_url);

        // 修复：检查正确的数据结构
        if (!result || !result.success || !result.data || !result.data.qrcode_url) {
          console.error('订单创建失败或数据结构错误:', result)
          alert('创建订单失败，请重试')
          return
        }
        
        // 修复：从 data 对象中获取字段
        const { order_id, qrcode_url } = result.data
        orderId = order_id
        
        console.log('订单ID:', orderId, '二维码URL:', qrcode_url)
        
        // 显示二维码
        document.getElementById('qrcode').src = qrcode_url  // 修复：使用 qrcode_url
        document.getElementById('qrcode').style.display = 'block'
        document.getElementById('tip').style.display = 'block'
        document.getElementById('pay-btn').style.display = 'none'

        // 轮询订单状态
        let tryTimes = 0
        const t = setInterval(async () => {
          console.log(`轮询第${tryTimes + 1}次，订单ID:`, orderId)
          const paid = await pollOrder(orderId, plan)
          
          if (paid) {
            clearInterval(t)
            console.log('支付成功！')
            
            // 支付成功后的处理
            const membershipName = plan === 'month' ? '基础版' : '尊享版'
            alert(`支付成功！您已成为${membershipName}会员`)
            
            // 立即跳转
            performRedirect()
            
          } else if (++tryTimes >= 150) {
            clearInterval(t)
            console.log('支付超时')
            alert('支付超时，请重试')
          }
        }, 2000)
        
      } catch (error) {
        console.error('支付流程异常:', error)
        alert('支付失败: ' + error.message)
      }
    }
    
    // "我已支付"按钮点击事件
    document.getElementById('tip').onclick = async () => {
      if (!orderId) {
        alert('没有找到订单信息')
        return
      }
      
      console.log('手动检查支付状态，订单ID:', orderId)
      const paid = await pollOrder(orderId, plan)
      
      if (paid) {
        const membershipName = plan === 'month' ? '基础版' : '尊享版'
        alert(`支付成功！您已成为${membershipName}会员`)
        performRedirect()
      } else {
        alert('暂未检测到支付，请稍候或刷新页面重试')
      }
    }

    // 专门的跳转函数
    function performRedirect() {
        console.log('执行页面跳转...');
        
        // 先设置一个标记，表示支付成功
        localStorage.setItem('payment_success', 'true');
        localStorage.setItem('payment_plan', plan);
        localStorage.setItem('payment_timestamp', new Date().toISOString());
        
        // 强制刷新首页以确保会员状态更新
        if (document.referrer && document.referrer.includes(location.hostname)) {
            console.log('返回上一页并刷新:', document.referrer);
            // 使用 replace 确保浏览器不会缓存旧状态
            window.location.replace('./index.html?payment=success');
        } else {
            console.log('跳转到首页');
            window.location.replace('./index.html?payment=success');
        }
    }
  </script>
</body>
</html>