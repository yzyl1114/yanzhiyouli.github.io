import{getUser as e,logout as t,loginWechat as n}from"./auth.js";import{getMyCustomGoals as i,createCustomGoal as o,deleteCustomGoal as a,updateCustomGoal as r}from"./custom.js";import{checkMembershipAndCleanup as s,getCurrentUser as c}from"./member.js";import{exams as d}from"./exams.js";const l=window.moment;function m(){const e=l().tz("Asia/Shanghai"),t=`${e.year()}年${e.month()+1}月${e.date()}日，星期${["日","一","二","三","四","五","六"][e.day()]}`;document.getElementById("current-date").textContent=t}function p(e){const t=l().tz("Asia/Shanghai");return e.slice().sort((e,n)=>l(e.date).diff(t)-l(n.date).diff(t))}function u(){const e=document.querySelector(".entry-grid");e.innerHTML="";p(d).forEach(t=>{const n=l().tz("Asia/Shanghai"),i=l(t.date).diff(n),o=document.createElement("div");o.className="entry-item",i<=0?(o.classList.add("entry-ended"),o.innerHTML=`\n                <div class="overlay"></div>\n                <div class="ended-badge">已结束</div>\n                <img src="${t.image}" alt="${t.name}" class="entry-image">\n                <h3 class="entry-title">${t.name}</h3>\n            `):o.innerHTML=`\n                <img src="${t.image}" alt="${t.name}" class="entry-image">\n                <h3 class="entry-title">${t.name}</h3>\n            `,o.addEventListener("click",()=>{window.location.href=`countdown.html?id=${t.id}`}),e.appendChild(o)})}function f(){const e=document.getElementById("activity-modal");Math.random()>.3&&!localStorage.getItem("activityModalShown")&&(e.style.display="flex",localStorage.setItem("activityModalShown","true"))}function y(e){const t=document.getElementById("user-bar-container");if(!t)return;t.innerHTML="";const i=document.createElement("div");if(i.className="user-bar",i.style.cssText="\n        margin-left: auto;\n        margin-right: 20px;\n        cursor: pointer;\n        display: flex;\n        align-items: center;\n        gap: 10px;\n    ",e){let t="普通用户",n="color: #666; font-size: 12px;";if(e.is_member){const i=new Date,o=e.member_expires_at?new Date(e.member_expires_at):null;if(o&&o<i)t="会员已过期",n="color: #ff6b6b; font-size: 12px;";else if(t="month"===e.member_plan?"基础版会员":"尊享版会员",n="color: #4a6bff; font-size: 12px;",o){t+=` (${Math.ceil((o-i)/864e5)}天)`}}i.innerHTML=`\n            <div style="text-align: right;">\n                <div style="font-size: 14px; font-weight: 500;">${e.username||"用户"}</div>\n                <div style="${n}">${t}</div>\n            </div>\n            <img src="${e.avatar_url||"images/default-avatar.png"}" \n                 style="width:30px;height:30px;border-radius:50%;border: 2px solid ${e.is_member?"#4a6bff":"#ddd"};">\n        `,i.onclick=()=>g(e)}else i.innerHTML='\n            <div style="text-align: right;">\n                <div style="font-size: 14px; font-weight: 500;">未登录</div>\n                <div style="color: #666; font-size: 12px;">点击登录</div>\n            </div>\n            <img src="images/default-avatar.png" \n                 style="width:30px;height:30px;border-radius:50%;border: 2px solid #ddd;">\n        ',i.onclick=()=>n();t.appendChild(i)}function g(e){const t=document.querySelector(".user-popup");if(t)return void t.remove();const n=document.createElement("div");n.className="user-popup",n.style.cssText="\n        position: absolute;\n        top: 60px;\n        right: 20px;\n        background: white;\n        border-radius: 8px;\n        box-shadow: 0 4px 20px rgba(0,0,0,0.15);\n        padding: 16px;\n        z-index: 1000;\n        min-width: 200px;\n        border: 1px solid #eee;\n    ";let i="";if(e.is_member){const t=e.member_expires_at?new Date(e.member_expires_at):null,n=new Date;if(t&&t<n)i='\n                <div style="color: #ff6b6b; font-size: 12px; margin: 8px 0; padding: 8px; background: #fff5f5; border-radius: 4px;">\n                    ⚠️ 会员已过期\n                </div>\n            ';else{const o=t?Math.ceil((t-n)/864e5):0;i=`\n                <div style="color: #4a6bff; font-size: 12px; margin: 8px 0; padding: 8px; background: #f6f9ff; border-radius: 4px;">\n                    ✅ ${"month"===e.member_plan?"基础版":"尊享版"}会员\n                    <br>剩余 ${o} 天\n                </div>\n            `}}n.innerHTML=`\n        <div style="font-weight: 500; margin-bottom: 12px;">账户信息</div>\n        ${i}\n        <div style="display: flex; gap: 8px; margin-top: 12px;">\n            ${e.is_member?"":'\n                <button onclick="location.href=\'member-buy.html\'" \n                        style="flex:1; padding: 8px 12px; background: #4a6bff; color: white; border: none; border-radius: 4px; font-size: 12px; cursor: pointer;">\n                    开通会员\n                </button>\n            '}\n            <button onclick="handleLogout()" \n                    style="flex:1; padding: 8px 12px; background: #f5f5f5; color: #666; border: none; border-radius: 4px; font-size: 12px; cursor: pointer;">\n                退出登录\n            </button>\n        </div>\n    `,document.body.appendChild(n),setTimeout(()=>{const e=t=>{n.contains(t.target)||t.target.closest(".user-bar")||(n.remove(),document.removeEventListener("click",e))};document.addEventListener("click",e)},100)}async function h(){try{await t(),location.reload()}catch(e){}}async function b(){try{const e=await c();if(!e)return;const t=new Date,n=e.member_expires_at&&new Date(e.member_expires_at)<t;e.is_member}catch(e){}}async function x(e){const t=document.querySelector(".entry-grid");if(!t)return;if(document.querySelectorAll(".custom-goal, .custom-plus").forEach(e=>{e.remove()}),e)try{const n=new Date,o=e.member_expires_at&&new Date(e.member_expires_at)<n;if(!(e.is_member&&!o))return;const a=await i();a.forEach(e=>{const n=document.createElement("div");n.className="entry-item custom-goal",n.setAttribute("data-goal-id",e.id),n.innerHTML=`\n                <img src="images/custom-plus.jpg" class="entry-image">\n                <h3 class="entry-title">${e.name}</h3>\n                <i class="edit-icon" style="display:none">✏️</i>\n                <i class="del-icon" style="display:none">🗑️</i>\n            `,n.addEventListener("click",t=>{t.target.classList.contains("del-icon")||t.target.classList.contains("edit-icon")||(window.location.href=`countdown.html?custom=${e.id}`)}),n.addEventListener("mouseenter",()=>{const e=n.querySelector(".edit-icon"),t=n.querySelector(".del-icon");e&&(e.style.display="block"),t&&(t.style.display="block")}),n.addEventListener("mouseleave",()=>{const e=n.querySelector(".edit-icon"),t=n.querySelector(".del-icon");e&&(e.style.display="none"),t&&(t.style.display="none")}),t.prepend(n)});const r="month"===e.member_plan?3:5;if(a.length<r){const e=document.createElement("div");e.className="entry-item custom-plus",e.innerHTML='\n                <img src="images/plus.svg" class="entry-image">\n                <h3 class="entry-title">自定义目标</h3>\n            ',e.onclick=()=>v(),t.prepend(e)}}catch(e){}}function v(){const e=prompt("请输入目标名称:");e&&e.trim()&&o(e.trim())}function w(e){const t=prompt("修改目标名称:",e.name);t&&t.trim()&&e.name}async function _(){try{await s()&&setTimeout(()=>{location.reload()},1e3)}catch(e){}}async function L(){if(void 0!==l&&void 0!==l.tz)try{const t=await e();y(t),await b(),await x(t),m(),u(),f(),document.querySelectorAll(".close-modal").forEach(e=>{e.addEventListener("click",()=>{document.querySelectorAll(".modal").forEach(e=>{e.style.display="none"})})}),window.addEventListener("click",e=>{document.querySelectorAll(".modal").forEach(t=>{e.target===t&&(t.style.display="none")})}),await _(),setInterval(_,6e4)}catch(e){}}document.addEventListener("DOMContentLoaded",L),setInterval(m,6e4),top!==self&&(top.location=self.location),window.handleLogout=h,window.openCustomGoalDialog=v;