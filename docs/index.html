<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GoalCountdown - è€ƒè¯•å€’è®¡æ—¶</title>
    <link rel="stylesheet" href="css/style.css">
    <!-- å¼•ç”¨æœ¬åœ°å­˜å‚¨çš„è„šæœ¬æ–‡ä»¶ -->
    <script src="js/moment.min.js"></script>
    <script src="js/moment-timezone-with-data-10-year-range.min.js"></script>
    <script type="module" src="js/auth.js"></script>
    <!-- è°·æ­Œå¹¿å‘Šå®¡æ ¸ä»£ç  -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7268374810307592"crossorigin="anonymous"></script>
</head>
<body>
    <!-- æ ‡é¢˜æ  -->
    <header class="header">
        <div class="logo-container">
            <img src="images/logo.png" alt="GoalCountdown Logo" class="logo">
            <h1>GoalCountdown</h1>
        </div>
        <div class="date-container" style="margin-left:auto;margin-right:20px;">
            <span id="current-date">2025å¹´01æœˆ01æ—¥ï¼Œæ˜ŸæœŸä¸‰</span>
        </div>
        <div class="user-bar"></div>

        <!-- æ–°å¢ç™»å½•æŒ‰é’® -->
        <!-- æ›¿æ¢åŸæ¥çš„ <button id="btn-login"...> -->
        <img id="user-avatar" src="images/default-avatar.png" style="width:30px;height:30px;border-radius:50%;margin-left:auto;margin-right:20px;cursor:pointer;display:none;">
    </header>

    <!-- Banner -->
    <section class="banner">
        <img src="images/banner.jpg" alt="è€ƒè¯•å€’è®¡æ—¶ç½‘ç«™å®£ä¼ " class="banner-image">
    </section>

    <!-- å€’è®¡æ—¶å…¥å£ -->
    <section class="countdown-entries">
        <div class="entry-grid">
            <!-- åŠ¨æ€ç”Ÿæˆçš„å€’è®¡æ—¶å…¥å£å°†é€šè¿‡JSæ’å…¥ -->
        </div>
    </section>

    <!-- å¤‡æ¡ˆåŠè”ç³»æ–¹å¼ -->
    <footer class="footer">
        <div class="beian">
            <a href="https://beian.mps.gov.cn/#/query/webSearch?code=11010502057033" target="_blank" rel="noreferrer">
                <img src="images/beian.png" alt="å…¬å®‰è”ç½‘å¤‡æ¡ˆå›¾æ ‡"> äº¬å…¬ç½‘å®‰å¤‡11010502057033å·
            </a>
            <a href="http://beian.miit.gov.cn/" target="_blank" rel="noreferrer">äº¬ICPå¤‡2024094021å·</a>
        </div>
        <div class="contact">
            <span>å•†åŠ¡åˆä½œ goalcountdown@gmail.com</span>
        </div>
    </footer>

    <!-- æ´»åŠ¨å¼¹çª— -->
    <div class="modal activity-modal" id="activity-modal">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <h2 class="modal-title">æ–°ç”¨æˆ·ä¸“äº«æ´»åŠ¨</h2>
            <div class="modal-body">
                <p>æ³¨å†Œå³é€3æ¬¡è‡ªå®šä¹‰å€’è®¡æ—¶æœºä¼šï¼</p>
                <button class="btn-primary">ç«‹å³å‚ä¸</button>
            </div>
        </div>
    </div>

    <!-- ç™»å½•é€»è¾‘ï¼ˆæ¨¡å—è„šæœ¬ï¼‰ -->
    <script type="module">
      import { supabase } from './js/supabase.js';
      document.getElementById('btn-login').onclick = () =>
        supabase.auth.signInWithOAuth({ 
          provider: 'github',
          options: { redirectTo:'https://yzyl1114.github.io/yanzhiyouli.github.io/index.html' } 
        });
      import { getUser } from './js/auth.js';
      import { getMyCustomGoals, createCustomGoal, deleteCustomGoal } from './js/custom.js';

      (async () => {
        const user = await getUser();
        const grid = document.querySelector('.entry-grid');

        /* 1. æ¸²æŸ“å·²æœ‰è‡ªå®šä¹‰ç›®æ ‡ */
        const list = await getMyCustomGoals();
        list.forEach(g => {
          const item = document.createElement('div');
          item.className = 'entry-item custom-goal';
          item.innerHTML = `
            <img src="images/custom-plus.jpg" class="entry-image">
            <h3 class="entry-title">${g.name}</h3>
            <i class="edit-icon" style="display:none;position:absolute;top:6px;left:6px;background:rgba(0,0,0,.5);color:#fff;border-radius:3px;padding:2px 4px;font-size:12px;cursor:pointer">âœï¸</i>
            <i class="del-icon"  style="display:none;position:absolute;top:6px;right:6px;background:rgba(0,0,0,.5);color:#fff;border-radius:3px;padding:2px 4px;font-size:12px;cursor:pointer">ğŸ—‘ï¸</i>
          `;
          item.style.position = 'relative';
          item.onclick = () => location.href = `countdown1004.html?custom=${g.id}`;
          item.onmouseenter = () => {
            item.querySelector('.edit-icon').style.display = 'inline-block';
            item.querySelector('.del-icon').style.display = 'inline-block';
          };
          item.onmouseleave = () => {
            item.querySelector('.edit-icon').style.display = 'none';
            item.querySelector('.del-icon').style.display = 'none';
          };
          item.querySelector('.edit-icon').onclick = e => {
            e.stopPropagation();
            const btn = document.getElementById('btn-open-edit');
            btn.dataset.gid = g.id;
            btn.click();
          };
          item.querySelector('.del-icon').onclick = async e => {
            e.stopPropagation();
            if (!confirm('ç¡®å®šåˆ é™¤ï¼Ÿ')) return;
            await deleteCustomGoal(g.id);   // âœ… ç”¨å°è£…å‡½æ•°
            location.reload();
          };
          grid.prepend(item);
        });

        /* 2. å§‹ç»ˆæ˜¾ç¤ºâ€œ+â€å¡ç‰‡ï¼Œæœªç™»å½•=ç™»å½•ï¼Œéä¼šå‘˜=æ”¯ä»˜ */
        const plus = document.createElement('div');
        plus.className = 'entry-item custom-plus';
        plus.innerHTML = `
          <img src="images/plus.svg" class="entry-image">
          <h3 class="entry-title">è‡ªå®šä¹‰ç›®æ ‡</h3>`;
        plus.onclick = () => {
          if (!user) { avatar.click(); return; }          // æœªç™»å½•â†’ç™»å½•
          if (!user.is_member) {                          // éä¼šå‘˜â†’æ”¯ä»˜
            document.getElementById('btn-open-pay').click();
            return;
          }
          // ä¼šå‘˜â†’æ–°å»º
          document.getElementById('btn-open-new').click();
        };
        grid.appendChild(plus);   // æ³¨æ„ï¼šç”¨ appendChild æ”¾æœ€å
        })();
    </script>
    
    <!-- ç¦ç”¨å³é”®èœå•å’Œå¿«æ·é”® -->
    <script>
        document.addEventListener('contextmenu', function(e) {
            e.preventDefault();
        });
        document.addEventListener('keydown', function(e) {
            if (e.key === 'F12' || (e.ctrlKey && e.shiftKey && e.key === 'I')) {
                e.preventDefault();
            }
        });
    </script>

    <!-- å¼•ç”¨æœ¬åœ°å­˜å‚¨çš„è„šæœ¬æ–‡ä»¶ -->
    <script type="module" src="js/index.min.js"></script>

    <!-- ===== 1. æ”¯ä»˜å¼¹çª—è§¦å‘æŒ‰é’®ï¼ˆéšè—ï¼Œä»…ä»£ç è°ƒç”¨ï¼‰ ===== -->
    <button id="btn-open-pay" style="display:none"
            onclick="window.open('member-buy.html','_blank','width=400,height=500,left=200,top=100')"></button>

    <!-- ===== 2. æ–°å»ºç›®æ ‡è§¦å‘æŒ‰é’®ï¼ˆéšè—ï¼‰ ===== -->
    <button id="btn-open-new" style="display:none"
            onclick="window.open('custom-goal.html','_blank','width=400,height=420,left=200,top=100')"></button>

    <!-- ===== 3. ç¼–è¾‘ç›®æ ‡è§¦å‘æŒ‰é’®ï¼ˆéšè—ï¼‰ ===== -->
    <button id="btn-open-edit" style="display:none"
            onclick="window.open('custom-goal.html?edit='+this.dataset.gid,'_blank','width=400,height=420,left=200,top=100')"></button>

    <!-- ===== 4. ç”¨æˆ·å°å¼¹çª—ï¼ˆå¼€é€š/ç»­è´¹ï¼‰ ===== -->
    <script type="module">
      import { supabase } from './js/supabase.js';
      import { getUser, logout } from './js/auth.js';
      let user = await getUser();

      /* ä¸€é”®æ¸²æŸ“å¤´åƒ/ç™»å½• */
      async function renderAuthEntry(){
        const user = await getUser();
        const avatar = document.getElementById('user-avatar');
        if(user){
          avatar.src = user.avatar_url || 'images/default-avatar.png';
          avatar.style.display = 'block';
          avatar.onclick = () => toggleUserPopup(user); // å¤ç”¨ä½ å·²æœ‰çš„å¼¹çª—é€»è¾‘
        }else{
          avatar.style.display = 'block';  // æœªç™»å½•ä¹Ÿæ˜¾ç¤ºï¼Œç‚¹å‡»å³ç™»å½•
          avatar.src = 'images/default-avatar.png';
          avatar.onclick = () => supabase.auth.signInWithOAuth({provider:'github'});
        }
      }
      renderAuthEntry();

      /* ---- å¯¼èˆªæ å¤´åƒåŒºåŸŸç‚¹å‡» ---- */
      document.addEventListener('click', e => {
        const ava = e.target.closest('.user-bar img');
        if (!ava) return;
        if (!user) return;                       // æœªç™»å½•ä¸å¼¹
        const popup = document.createElement('div');
        popup.id = 'user-popup';
        popup.innerHTML = `
          <div style="position:absolute;right:20px;top:60px;background:#fff;border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,.15);padding:12px;font-size:14px;line-height:1.8;z-index:999";white-space: nowrap>
            <div>${user.username || 'ç”¨æˆ·'}</div>
            <div style="color:#666">${user.is_member ? (user.member_plan==='month'?'åŸºç¡€ç‰ˆ':'å°Šäº«ç‰ˆ')+'ä¼šå‘˜' : 'æ™®é€šç”¨æˆ·'}</div>
            <div style="color:#666">${user.is_member ? 'å°†äº '+Math.ceil((new Date(user.member_expires_at)-Date.now())/86400000)+' å¤©ååˆ°æœŸ' : 'å¼€é€šä¼šå‘˜ç«‹äº«æƒç›Š'}</div>
            <button id="popup-buy" style="float:right;margin-top:-40px;height:24px;border:none;border-radius:4px;background:#4a6bff;color:#fff;font-size:12px;cursor:pointer">${user.is_member?'ç»­è´¹':'å¼€é€š'}</button>
            <button id="popup-out" style="width:100%;margin-top:10px;border:none;background:none;color:#ff4d4f;cursor:pointer">é€€å‡ºç™»å½•</button>
          </div>`;
        document.body.appendChild(popup);
        popup.querySelector('#popup-buy').onclick = () => document.getElementById('btn-open-pay').click();
        popup.querySelector('#popup-out').onclick = async () => { await logout(); location.reload(); };
        const close = e => { if (!e.target.closest('#user-popup')) { popup.remove(); document.removeEventListener('click', close); } };
        setTimeout(() => document.addEventListener('click', close), 0);
      });
    </script>
</body>
</html>