<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <title>开通会员</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box;}
    body{font-family:PingFang SC,Helvetica;background:#f5f5f5;display:flex;justify-content:center;align-items:center;height:100vh}
    .box{background:#fff;width:420px;border-radius:12px;box-shadow:0 8px 30px rgba(0,0,0,.12);overflow:hidden}
    .header{height:56px;display:flex;align-items:center;justify-content:center;font-size:18px;font-weight:500;border-bottom:1px solid #f0f0f0}
    .cards{display:flex;gap:16px;padding:24px}
    .card{flex:1;border:2px solid transparent;border-radius:8px;padding:16px;cursor:pointer;transition:.2s}
    .card.month{border-color:#4a6bff;background:#f6f9ff}
    .card.halfyear{border-color:#ff6a00;background:#fff9f0}
    .card:hover{border-color:#4a6bff}
    .card.active{border-color:#4a6bff;background:#f6f9ff}
    .card h3{font-size:16px;margin-bottom:4px}
    .card small{font-size:12px;color:#666}
    .row{display:flex;justify-content:space-between;font-size:13px;margin-top:8px}
    .foot{padding:0 24px 24px}
    #pay-btn{width:100%;height:40px;border:none;border-radius:6px;background:#07c160;color:#fff;font-size:15px;cursor:pointer}
    #qrcode{width:80px;height:80px;margin:12px auto;display:block}
    #tip{text-align:center;font-size:12px;color:#4a6bff;cursor:pointer;margin-top:6px}
    .cancel{text-align:center;font-size:12px;color:#999;margin-top:12px;cursor:pointer}
  </style>
  <script type="module" src="js/member.js"></script>
</head>
<body>
  <div class="box">
    <div class="header">开通会员</div>
    <div class="cards">
      <div class="card" data-plan="month">
        <h3>基础版</h3><small>30 天会员</small>
        <div class="row"><span>会员专属背景图</span><span>✅</span></div>
        <div class="row"><span>自定义倒计时事件</span><span>✅</span></div>
        <div class="row"><span>保存数量</span><span>3 个</span></div>
      </div>
      <div class="card" data-plan="halfyear">
        <h3>尊享版</h3><small>180 天会员</small>
        <div class="row"><span>会员专属背景图</span><span>✅</span></div>
        <div class="row"><span>自定义倒计时事件</span><span>✅</span></div>
        <div class="row"><span>保存数量</span><span>5 个</span></div>
      </div>
    </div>
    <div class="foot">
      <button id="pay-btn">微信支付</button>
      <img id="qrcode" style="display:none">
      <div id="tip" style="display:none">我已支付</div>
      <div class="cancel" onclick="window.close()">取消</div>
    </div>
  </div>

  <script type="module">
      import { createOrder, pollOrder } from './js/member.js'
      import { getUser } from './js/auth.js'
          
      let plan = 'month', orderId

      // 初始化页面
      async function initPage() {
          const user = await getUser()
          console.log('当前用户状态:', user) // 调试信息
          
          // 清除所有卡片的active状态
          document.querySelectorAll('.card').forEach(x => x.classList.remove('active'))
          
          // 简化逻辑：非会员和尊享版会员都默认选择基础版
          // 只有基础版会员才默认选择尊享版
          if (user && user.is_member && user.member_plan === 'month') {
              // 基础版会员默认选择尊享版（用于升级）
              plan = 'halfyear'
              document.querySelector('.card.halfyear').classList.add('active')
              console.log('基础版会员，默认选择尊享版（升级）')
          } else {
              // 非会员、尊享版会员、或查询失败都默认选择基础版
              plan = 'month'
              document.querySelector('.card.month').classList.add('active')
              console.log('非会员/尊享版会员，默认选择基础版')
          }
          
          updatePayButtonText()
      }

      // 更新支付按钮文案
      function updatePayButtonText() {
          const payBtn = document.getElementById('pay-btn')
          if (plan === 'month') {
              payBtn.textContent = '¥6 微信支付'
          } else {
              payBtn.textContent = '¥19 微信支付'
          }
      }

      // 初始化卡片选择
      document.querySelectorAll('.card').forEach(c => c.onclick = () => {
          document.querySelectorAll('.card').forEach(x => x.classList.remove('active'))
          c.classList.add('active')
          plan = c.dataset.plan
          console.log('选择套餐:', plan)
          updatePayButtonText()
      })

      // 页面加载时初始化 - 确保在DOM加载完成后执行
      document.addEventListener('DOMContentLoaded', async () => {
          await initPage()
      })
    
    // 支付按钮点击事件
    document.getElementById('pay-btn').onclick = async () => {
      try {
        console.log('开始创建订单，套餐:', plan)
        
        const result = await createOrder(plan)
        console.log('订单创建结果:', result)
        
        if (!result || !result.qr_url) {
          alert('创建订单失败，请重试')
          return
        }
        
        const { qr_url, order_id } = result
        orderId = order_id
        
        console.log('订单ID:', orderId, '二维码URL:', qr_url)
        
        // 显示二维码
        document.getElementById('qrcode').src = qr_url
        document.getElementById('qrcode').style.display = 'block'
        document.getElementById('tip').style.display = 'block'
        document.getElementById('pay-btn').style.display = 'none'

        // 轮询订单状态
        let tryTimes = 0
        const t = setInterval(async () => {
          console.log(`轮询第${tryTimes + 1}次，订单ID:`, orderId)
          const paid = await pollOrder(orderId, plan)
          
          if (paid) {
            clearInterval(t)
            console.log('支付成功！')
            
            // 支付成功后的处理
            const membershipName = plan === 'month' ? '基础版' : '尊享版'
            alert(`支付成功！您已成为${membershipName}会员`)
            
            // 立即跳转
            performRedirect()
            
          } else if (++tryTimes >= 150) {
            clearInterval(t)
            console.log('支付超时')
            alert('支付超时，请重试')
          }
        }, 2000)
        
      } catch (error) {
        console.error('支付流程异常:', error)
        alert('支付失败: ' + error.message)
      }
    }
    
    // "我已支付"按钮点击事件 - 修复版本
    document.getElementById('tip').onclick = async () => {
      if (!orderId) {
        alert('没有找到订单信息')
        return
      }
      
      console.log('手动检查支付状态，订单ID:', orderId)
      
      // 这里需要调用 pollOrder 函数获取支付状态
      const paid = await pollOrder(orderId, plan)  // 添加这行
      
      if (paid) {
        const membershipName = plan === 'month' ? '基础版' : '尊享版'
        alert(`支付成功！您已成为${membershipName}会员`)
        
        // 立即跳转
        performRedirect()
      } else {
        alert('暂未检测到支付，请稍候或刷新页面重试')
      }
    }

    // 专门的跳转函数
    function performRedirect() {
      console.log('执行页面跳转...')
      console.log('来源页面:', document.referrer)
      console.log('当前主机:', location.hostname)
      
      // 方法1: 使用 history.back() 返回上一页
      if (document.referrer && document.referrer.includes(location.hostname)) {
        console.log('返回上一页:', document.referrer)
        history.back()
      } 
      // 方法2: 直接跳转到首页
      else {
        console.log('跳转到首页')
        window.location.href = './index.html'
      }
      
      // 方法3: 如果上述方法都失败，3秒后强制跳转
      setTimeout(() => {
        console.log('检查是否需要强制跳转...')
        window.location.href = './index.html'
      }, 3000)
    }
  </script>
</body>
</html>