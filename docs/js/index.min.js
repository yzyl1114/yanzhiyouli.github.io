import{getUser,logout}from"./auth.js";import{getMyCustomGoals,createCustomGoal,deleteCustomGoal}from"./custom.js";import{openMemberBuyDialog}from"./member.js";import{exams}from"./exams.js";const moment=window.moment;function updateCurrentDate(){const now=moment().tz("Asia/Shanghai");const weekdays=["日","一","二","三","四","五","六"];const dateStr=`${now.year()}年${now.month()+1}月${now.date()}日，星期${weekdays[now.day()]}`;document.getElementById("current-date").textContent=dateStr}function sortExamsByProximity(exams){const now=moment().tz("Asia/Shanghai");return exams.slice().sort((a,b)=>{const diffA=moment(a.date).diff(now);const diffB=moment(b.date).diff(now);return diffA-diffB})}function renderCountdownEntries(){const entryGrid=document.querySelector(".entry-grid");entryGrid.innerHTML="";const sortedExams=sortExamsByProximity(exams);sortedExams.forEach(exam=>{const now=moment().tz("Asia/Shanghai");const examTime=moment(exam.date);const diff=examTime.diff(now);const entryItem=document.createElement("div");entryItem.className="entry-item";if(diff<=0){entryItem.classList.add("entry-ended");entryItem.innerHTML=`\n                <div class="overlay"></div>\n                <div class="ended-badge">已结束</div>\n                <img src="${exam.image}" alt="${exam.name}" class="entry-image">\n                <h3 class="entry-title">${exam.name}</h3>\n            `}else{entryItem.innerHTML=`\n                <img src="${exam.image}" alt="${exam.name}" class="entry-image">\n                <h3 class="entry-title">${exam.name}</h3>\n            `}entryItem.addEventListener("click",()=>{window.location.href=`countdown.html?id=${exam.id}`});entryGrid.appendChild(entryItem)})}function showActivityModal(){const activityModal=document.getElementById("activity-modal");if(Math.random()>.3&&!localStorage.getItem("activityModalShown")){activityModal.style.display="flex";localStorage.setItem("activityModalShown","true")}}async function initHomePage(){if(typeof moment==="undefined"||typeof moment.tz==="undefined"){console.error("Moment.js 或 Moment-Timezone 未正确加载");return}const user=await getUser();renderUserBar(user);await renderCustomCards(user);updateCurrentDate();renderCountdownEntries();showActivityModal();document.querySelectorAll(".close-modal").forEach(closeBtn=>{closeBtn.addEventListener("click",()=>{document.querySelectorAll(".modal").forEach(modal=>{modal.style.display="none"})})});window.addEventListener("click",e=>{document.querySelectorAll(".modal").forEach(modal=>{if(e.target===modal){modal.style.display="none"}})})}document.addEventListener("DOMContentLoaded",initHomePage);setInterval(updateCurrentDate,6e4);if(top!==self){top.location=self.location}function renderUserBar(user){const dateContainer=document.querySelector(".date-container");const wrap=document.createElement("div");wrap.className="user-bar";wrap.style.marginLeft="auto";wrap.style.marginRight="20px";wrap.style.cursor="pointer";if(user){wrap.innerHTML=`<img src="${user.avatar_url}" style="width:30px;height:30px;border-radius:50%">`;wrap.onclick=()=>toggleUserPopup(user)}else{wrap.innerHTML=`<img src="images/default-avatar.png" style="width:30px;height:30px;border-radius:50%">`;wrap.onclick=()=>loginWechat()}dateContainer.after(wrap)}async function renderCustomCards(user){const grid=document.querySelector(".entry-grid");const canCreate=user&&user.is_member&&(await getMyCustomGoals()).length<(user.member_plan==="month"?3:5);const list=await getMyCustomGoals();list.forEach(g=>{const item=document.createElement("div");item.className="entry-item custom-goal";item.innerHTML=`\n            <img src="images/custom-plus.jpg" class="entry-image">\n            <h3 class="entry-title">${g.name}</h3>\n            <i class="edit-icon" style="display:none">✏️</i>\n            <i class="del-icon"  style="display:none">🗑️</i>\n        `;item.onclick=()=>location.href=`countdown.html?custom=${g.id}`;item.onmouseenter=()=>{item.querySelector(".edit-icon").style.display="block";item.querySelector(".del-icon").style.display="block"};item.onmouseleave=()=>{item.querySelector(".edit-icon").style.display="none";item.querySelector(".del-icon").style.display="none"};grid.prepend(item)});if(canCreate){const plus=document.createElement("div");plus.className="entry-item custom-plus";plus.innerHTML=`\n            <img src="images/plus.svg" class="entry-image">\n            <h3 class="entry-title">自定义目标</h3>\n        `;plus.onclick=()=>openCustomGoalDialog();grid.prepend(plus)}}